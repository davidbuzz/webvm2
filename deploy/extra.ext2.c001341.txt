/*
 * This file is free software: you can redistribute it and/or modify it
 * under the terms of the GNU General Public License as published by the
 * Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This file is distributed in the hope that it will be useful, but
 * WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
 * See the GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along
 * with this program.  If not, see <http://www.gnu.org/licenses/>.
 *
 * Copyright (C) 2021 Siddharth Bharat Purohit, CubePilot Pty Ltd
 */

#include <CrashCatcher.h>
#include <ch.h>
#include "hal.h"
#include "string.h"
#include "watchdog.h"
#include "stm32_util.h"
#include "flash.h"

CRASH_CATCHER_TEST_WRITEABLE CrashCatcherReturnCodes g_crashCatcherDumpEndReturn = CRASH_CATCHER_TRY_AGAIN;
static                       CrashCatcherInfo        g_info;

static bool do_flash_crash_dump = true;
static void* dump_start_address;
static void* dump_end_address;

static void CrashCatcher_DumpStartFlash(const CrashCatcherInfo* pInfo);
static CrashCatcherReturnCodes CrashCatcher_DumpEndFlash(void);
static void CrashCatcher_DumpMemoryFlash(const void* pvMemory, CrashCatcherElementSizes elementSize, size_t elementCount);

#if defined(HAL_CRASH_SERIAL_PORT)
static bool uart_initialised = false;
static bool do_serial_crash_dump = false;

#ifndef HAL_CRASH_SERIAL_PORT_BAUD
#define HAL_CRASH_SERIAL_PORT_BAUD 921600
#endif // HAL_CRASH_SERIAL_PORT_BAUD

#if !defined(USART_ISR_RXNE)
#define USART_ISR_RXNE                      USART_ISR_RXNE_RXFNE
#endif
static void printString(const char* pString);
static void waitForUserInput(void);
static void dumpBytes(const uint8_t* pMemory, size_t elementCount);
static void dumpByteAsHex(uint8_t byte);
static void dumpHexDigit(uint8_t nibble);
static void dumpHalfwords(const uint16_t* pMemory, size_t elementCount);
static void dumpWords(const uint32_t* pMemory, size_t elementCount);
static void CrashCatcher_DumpStartHex(const CrashCatcherInfo* pInfo);
static CrashCatcherReturnCodes CrashCatcher_DumpEndHex(void);
static void CrashCatcher_DumpMemoryHex(const void* pvMemory, CrashCatcherElementSizes elementSize, size_t elementCount);
#endif // HAL_CRASH_SERIAL_PORT

extern uint32_t __crash_log_base__, __crash_log_end__;

uint32_t stm32_crash_dump_size(void)
{
    uint32_t* page_addr = (uint32_t*)&__crash_log_base__;
    uint32_t page_size = stm32_crash_dump_max_size();
    return page_addr[(page_size / sizeof(uint32_t)) - 1];
}

uint32_t stm32_crash_dump_max_size(void)
{
    return (uint32_t)&__crash_log_end__ - (uint32_t)&__crash_log_base__;
}

uint32_t stm32_crash_dump_addr(void)
{
    return (uint32_t)&__crash_log_base__;
}

bool stm32_crash_dump_region_erased(void)
{
    for (uint32_t i = 0; i < stm32_crash_dump_max_size(); i += 4) {
        if (((uint32_t*)stm32_crash_dump_addr())[i / 4] != 0xFFFFFFFF) {
            return false;
        }
    }
    return true;
}

#define ARRAY_SIZE(X) (sizeof(X)/sizeof(X[0]))
extern uint32_t __ram0_start__, __ram0_end__, __heap_base__, __heap_end__, __bss_base__, __bss_end__;
#define REMAINDER_MEM_REGION_SIZE (15000) // remainder memory for crashcatcher internal regions
static uint32_t dump_size = 0;
static uint8_t dump_buffer[32]; // we need to maintain a dump buffer of 32bytes for H7
static uint8_t buf_off = 0;

const CrashCatcherMemoryRegion* CrashCatcher_GetMemoryRegions(void);
const CrashCatcherMemoryRegion* CrashCatcher_GetMemoryRegions(void)
{
    // do a full dump if on serial
    static CrashCatcherMemoryRegion regions[60] = {
    {(uint32_t)&__ram0_start__, (uint32_t)&__ram0_end__, CRASH_CATCHER_BYTE},
    {(uint32_t)&ch_system, (uint32_t)&ch_system + sizeof(ch_system), CRASH_CATCHER_BYTE}};
    uint32_t total_dump_size = dump_size + buf_off + REMAINDER_MEM_REGION_SIZE;
    // loop through chibios threads and add their stack info
    uint8_t curr_region = 2;
    for (thread_t *tp = chRegFirstThread(); tp && (curr_region < (ARRAY_SIZE(regions) - 1)); tp = chRegNextThread(tp)) {
        uint32_t total_stack;
        if (tp->wabase == (void*)&__main_thread_stack_base__) {
            // main thread has its stack separated from the thread context
            total_stack = (uint32_t)((const uint8_t *)&__main_thread_stack_end__ - (const uint8_t *)&__main_thread_stack_base__);
        } else {
            // all other threads have their thread context pointer
            // above the stack top
            total_stack = (uint32_t)(tp) - (uint32_t)(tp->wabase);
        }
        // log names if in RAM
        if (tp->name != NULL && is_address_in_memory((void*)tp->name)) {
            regions[curr_region].elementSize = CRASH_CATCHER_BYTE;
            regions[curr_region].startAddress = (uint32_t)(tp->name);
            regions[curr_region++].endAddress = (uint32_t)(tp->name) + 13;
        }
        // log thread info
        regions[curr_region].elementSize = CRASH_CATCHER_BYTE;
        regions[curr_region].startAddress = (uint32_t)(tp);
        regions[curr_region++].endAddress = (uint32_t)(tp) + sizeof(thread_t);
        // log thread stacks
        regions[curr_region].elementSize = CRASH_CATCHER_BYTE;
        regions[curr_region].startAddress = (uint32_t)(tp->wabase);
        regions[curr_region++].endAddress = (uint32_t)(tp->wabase) + total_stack;

        total_dump_size += total_stack;
        if ((total_dump_size) >= stm32_crash_dump_max_size()) {
            // we can't log anymore than this
            goto finalise;
        }
    }

    // log statically alocated memory
    int32_t bss_size = ((uint32_t)&__bss_end__) - ((uint32_t)&__bss_base__);
    int32_t available_space = stm32_crash_dump_max_size() - total_dump_size;
    if (available_space < 0) {
        // we can't log anymore than this
        goto finalise;
    }
    if (bss_size > available_space) { // dump however much we can
        regions[curr_region].elementSize = CRASH_CATCHER_BYTE;
        regions[curr_region].startAddress = (uint32_t)&__bss_base__;
        regions[curr_region++].endAddress = (uint32_t)&__bss_base__ + available_space;
        total_dump_size += available_space;
    } else { // dump the entire bss
        regions[curr_region].elementSize = CRASH_CATCHER_BYTE;
        regions[curr_region].startAddress = (uint32_t)&__bss_base__;
        regions[curr_region++].endAddress = (uint32_t)&__bss_end__;
        total_dump_size += bss_size;
    }

    // dump the Heap as well as much as we can
    int32_t heap_size = ((uint32_t)&__heap_end__) - ((uint32_t)&__heap_base__);
    available_space = stm32_crash_dump_max_size() - total_dump_size;
    if (available_space < 0) {
        // we can't log anymore than this
        goto finalise;
    }
    if (heap_size > available_space) { // dump however much we can
        regions[curr_region].elementSize = CRASH_CATCHER_BYTE;
        regions[curr_region].startAddress = (uint32_t)&__heap_base__;
        regions[curr_region++].endAddress = (uint32_t)&__heap_base__ + available_space;
        total_dump_size += available_space;
    } else { // dump the entire heap
        regions[curr_region].elementSize = CRASH_CATCHER_BYTE;
        regions[curr_region].startAddress = (uint32_t)&__heap_base__;
        regions[curr_region++].endAddress = (uint32_t)&__heap_end__;
        total_dump_size += heap_size;
    }

finalise:
    // ensure that last is filled with 0xFFFFFFFF
    if (curr_region < ARRAY_SIZE(regions)) {
        regions[curr_region].elementSize = CRASH_CATCHER_BYTE;
        regions[curr_region].startAddress = 0xFFFFFFFF;
        regions[curr_region].endAddress = 0xFFFFFFFF;
    } else {
        regions[ARRAY_SIZE(regions) - 1].elementSize = CRASH_CATCHER_BYTE;
        regions[ARRAY_SIZE(regions) - 1].startAddress = 0xFFFFFFFF;
        regions[ARRAY_SIZE(regions) - 1].endAddress = 0xFFFFFFFF;
    }

    if (do_flash_crash_dump) {
        // smaller dump if on flash
        regions[0].startAddress = (uint32_t)dump_start_address;
        regions[0].endAddress = (uint32_t)dump_end_address;
    }
    return regions;
}

void CrashCatcher_DumpMemory(const void* pvMemory, CrashCatcherElementSizes elementSize, size_t elementCount)
{
    (void)pvMemory;
    (void)elementSize;
    (void)elementCount;
#if defined(HAL_CRASH_SERIAL_PORT)
    if (do_serial_crash_dump) {
        CrashCatcher_DumpMemoryHex(pvMemory, elementSize, elementCount);
    }
#endif
    if (do_flash_crash_dump) {
        CrashCatcher_DumpMemoryFlash(pvMemory, elementSize, elementCount);
    }
}


void CrashCatcher_DumpStart(const CrashCatcherInfo* pInfo)
{
    // Record the fault info for watchdog
    struct port_extctx* ctx = (struct port_extctx*)pInfo->sp;
    FaultType faultType = (FaultType)__get_IPSR();
    save_fault_watchdog(__LINE__, faultType, pInfo->sp, ctx->lr_thd);
#if defined(HAL_CRASH_SERIAL_PORT)
    if (do_serial_crash_dump) {
        CrashCatcher_DumpStartHex(pInfo);
    }
#endif
    if (do_flash_crash_dump) {
        CrashCatcher_DumpStartFlash(pInfo);
    }
}

CrashCatcherReturnCodes CrashCatcher_DumpEnd(void)
{
#if defined(HAL_CRASH_SERIAL_PORT)
    if (do_serial_crash_dump) {
        return CrashCatcher_DumpEndHex();
    }
#endif
    if (do_flash_crash_dump) {
        return CrashCatcher_DumpEndFlash();
    }
    do_flash_crash_dump = false;
#if defined(HAL_CRASH_SERIAL_PORT)
    do_serial_crash_dump = true;
#endif
    return CRASH_CATCHER_TRY_AGAIN;
}

// -------------- FlashDump Code --------------------
static void CrashCatcher_DumpStartFlash(const CrashCatcherInfo* pInfo)
{
    // initialise for dumping
    void *sp = (void*)pInfo->sp;
    if (sp == NULL || !is_address_in_memory(sp)) {
        do_flash_crash_dump = false;
        return;
    }
    // let's set the memory range to be dumped
    if (get_addr_mem_region_start_addr(sp) + HAL_MAX_STACK_FRAME_SIZE > sp) {
        // only go until the start of the region
        dump_start_address = get_addr_mem_region_start_addr(sp);
    } else {
        // go back as far as we need to
        dump_start_address = sp - HAL_MAX_STACK_FRAME_SIZE;
    }

    if (get_addr_mem_region_end_addr(sp) < sp + HAL_PROCESS_STACK_SIZE) {
        // only go until the end of the region
        dump_end_address = get_addr_mem_region_end_addr(sp);
    } else {
        // go ahead as far as we need to
        dump_end_address = sp + HAL_PROCESS_STACK_SIZE;
    }

    dump_size = 0;
    buf_off = 0;
    // we expect crash dump flash page to already be empty
    if (!stm32_crash_dump_region_erased()) {
        // stuff is already there, maybe last dump
        // so just do nothing
        do_flash_crash_dump = false;
        return;
    }
    stm32_watchdog_pat();
    // unlock flash page for write
    stm32_flash_keep_unlocked(true);
}
// only flushes if we have a full buffer
static void flush_dump_buffer(void)
{
    if (buf_off == sizeof(dump_buffer)) {
        uint32_t page_start = (uint32_t)stm32_crash_dump_addr();
        // write dump buffer to flash
        stm32_flash_write(page_start + dump_size, dump_buffer, sizeof(dump_buffer));
        dump_size += sizeof(dump_buffer);
        buf_off = 0;
        memset(dump_buffer, 0, sizeof(dump_buffer));
        stm32_watchdog_pat();
    }
}

// Does the requested Dump to Flash
static void CrashCatcher_DumpMemoryFlash(const void* pvMemory, CrashCatcherElementSizes elementSize, size_t elementCount)
{
    const uint8_t* pv = (const uint8_t*)pvMemory;
    size_t cnt = 0;
    while (cnt < elementCount) {
        if (dump_size + buf_off + sizeof(dump_size) >= stm32_crash_dump_max_size()) {
            // when this happens, buf_off will be sizeof(buffer)-sizeof(dump_size)
            // 0xFF will be used to detect that we were in the middle of taking a dump
            memset(&dump_buffer[sizeof(dump_buffer)-sizeof(dump_size)], 0xFF, sizeof(dump_size));
            buf_off = sizeof(dump_buffer);
            return;
        }
        flush_dump_buffer();
        switch (elementSize)
        {
            case CRASH_CATCHER_BYTE:
                dump_buffer[buf_off++] = pv[cnt++];
                break;
            case CRASH_CATCHER_HALFWORD:
                // we need to split the half word into two parts
                dump_buffer[buf_off++] = (uint16_t)*pv & 0xFF;
                flush_dump_buffer();
                dump_buffer[buf_off++] = ((uint16_t)*pv >> 8) & 0xFF;
                cnt++;
                break;
            case CRASH_CATCHER_WORD:
                // we need to split the word and then write
                for (size_t i = 0; i < sizeof(uint32_t); i++) {
                    dump_buffer[buf_off++] = ((uint32_t)*pv >> (8*i)) & 0xFF;
                    flush_dump_buffer();
                }
                cnt++;
                break;
        }
    }
}

static CrashCatcherReturnCodes CrashCatcher_DumpEndFlash(void)
{
    // flush the buffer
    if (dump_size + buf_off + sizeof(dump_size) >= stm32_crash_dump_max_size()) {
        // when this happens, buf_off will be sizeof(buffer)-sizeof(dump_size)
        // 0xFF will be used to detect that we were in the middle of taking a dump
        memset(&dump_buffer[sizeof(dump_buffer)-sizeof(dump_size)], 0xFF, sizeof(dump_size));
        buf_off = sizeof(dump_buffer);
    }
    if (buf_off > 0) {
        if (dump_size + sizeof(dump_buffer) >= stm32_crash_dump_max_size() && buf_off < sizeof(dump_buffer)) {
            // we have a partially full buffer towards the end, so we need to write the buffer
            // and then write the size of the buffer
            memcpy(&dump_buffer[sizeof(dump_buffer)-sizeof(dump_size)], &dump_size, sizeof(dump_size));
            buf_off = 32;
        }
        stm32_flash_write(stm32_crash_dump_addr() + dump_size, dump_buffer, 32);
        dump_size += buf_off;
        buf_off = 0;
        memset(dump_buffer, 0, sizeof(dump_buffer));
        stm32_watchdog_pat();
    }

    // write size to buffer if not already written
    if (dump_size < stm32_crash_dump_max_size()) {
        memcpy(&dump_buffer[sizeof(dump_buffer)-sizeof(dump_size)], &dump_size, sizeof(dump_size));
        stm32_flash_write(stm32_crash_dump_addr() + stm32_crash_dump_max_size() - sizeof(dump_buffer), dump_buffer, sizeof(dump_buffer));
        stm32_watchdog_pat();
    }

    stm32_flash_keep_unlocked(false);
    // How big of a dump did we take, record that at the end of flash sector
    if (g_crashCatcherDumpEndReturn == CRASH_CATCHER_TRY_AGAIN && g_info.isBKPT)
        return CRASH_CATCHER_EXIT;
    else
        return g_crashCatcherDumpEndReturn;
}

// -------------- HexDump Code --------------------
/* Copyright (C) 2018  Adam Green (https://github.com/adamgreen)

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
*/
#if defined(HAL_CRASH_SERIAL_PORT)

static void CrashCatcher_DumpStartHex(const CrashCatcherInfo* pInfo)
{
    g_info = *pInfo;
    
    printString("\r\n\r\n");
    if (pInfo->isBKPT)
        printString("BREAKPOINT");
    else
        printString("CRASH");
    printString(" ENCOUNTERED\r\n"
                 "Enable logging and then press any key to start dump.\r\n");
    
    waitForUserInput();
    printString("\r\n");
}

static void printString(const char* pString)
{
    while (*pString)
        CrashCatcher_putc(*pString++);
}

static void waitForUserInput(void)
{
    CrashCatcher_getc();
}

static void CrashCatcher_DumpMemoryHex(const void* pvMemory, CrashCatcherElementSizes elementSize, size_t elementCount)
{
    switch (elementSize)
    {
        case CRASH_CATCHER_BYTE:
            dumpBytes(pvMemory, elementCount);
            break;
        case CRASH_CATCHER_HALFWORD:
            dumpHalfwords(pvMemory, elementCount);
            break;
        case CRASH_CATCHER_WORD:
            dumpWord

/*
 * Copyright (C) Siddharth Bharat Purohit 2017
 * This file is free software: you can redistribute it and/or modify it
 * under the terms of the GNU General Public License as published by the
 * Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This file is distributed in the hope that it will be useful, but
 * WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
 * See the GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along
 * with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
#include "hal.h"

#ifdef __cplusplus
extern "C" {
#endif
uint32_t stm32_flash_getpageaddr(uint32_t page);
uint32_t stm32_flash_getpagesize(uint32_t page);
uint32_t stm32_flash_getnumpages(void);
bool stm32_flash_erasepage(uint32_t page);
bool stm32_flash_write(uint32_t addr, const void *buf, uint32_t count);
void stm32_flash_keep_unlocked(bool set);
bool stm32_flash_ispageerased(uint32_t page);
void stm32_flash_protect_flash(bool bootloader, bool protect);
void stm32_flash_unprotect_flash(void);
void stm32_flash_set_NRST_MODE(uint8_t nrst_mode);
#if defined(STM32H7)
void stm32_flash_corrupt(uint32_t addr);
#endif
#ifndef HAL_BOOTLOADER_BUILD
bool stm32_flash_recent_erase(void);
#endif
#ifdef __cplusplus
}
#endif
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       /*
    ChibiOS - Copyright (C) 2006..2016 Giovanni Di Sirio

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.
*/
/*
 * This file is free software: you can redistribute it and/or modify it
 * under the terms of the GNU General Public License as published by the
 * Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This file is distributed in the hope that it will be useful, but
 * WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
 * See the GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along
 * with this program.  If not, see <http://www.gnu.org/licenses/>.
 * 
 * Modified for use in AP_HAL by Andrew Tridgell and Siddharth Bharat Purohit
 */

/**
 * @file    templates/halconf.h
 * @brief   HAL configuration header.
 * @details HAL configuration file, this file allows to enable or disable the
 *          various device drivers from your application. You may also use
 *          this file in order to override the device drivers default settings.
 *
 * @addtogroup HAL_CONF
 * @{
 */

#pragma once
#define _CHIBIOS_HAL_CONF_
#define _CHIBIOS_HAL_CONF_VER_8_4_

#include "mcuconf.h"

/**
 * @brief   Enables the PAL subsystem.
 */
#if !defined(HAL_USE_PAL) || defined(__DOXYGEN__)
#define HAL_USE_PAL                 TRUE
#endif

/**
 * @brief   Enables the ADC subsystem.
 */
#if !defined(HAL_USE_ADC) || defined(__DOXYGEN__)
#define HAL_USE_ADC                 TRUE
#endif

/**
 * @brief   Enables the CAN subsystem.
 */
#if !defined(HAL_USE_CAN) || defined(__DOXYGEN__)
#define HAL_USE_CAN                 FALSE
#endif

/**
 * @brief   Enables the cryptographic subsystem.
 */
#if !defined(HAL_USE_CRY) || defined(__DOXYGEN__)
#define HAL_USE_CRY                         FALSE
#endif

/**
 * @brief   Enables the DAC subsystem.
 */
#if !defined(HAL_USE_DAC) || defined(__DOXYGEN__)
#define HAL_USE_DAC                         FALSE
#endif

/**
 * @brief   Enables the EFlash subsystem.
 */
#if !defined(HAL_USE_EFL) || defined(__DOXYGEN__)
#define HAL_USE_EFL                         FALSE
#endif

/**
 * @brief Enables the GPT subsystem. We don't need it on most boards
 * in ArduPilot, so it is disabled by default
 */
#if !defined(HAL_USE_GPT) || defined(__DOXYGEN__)
#define HAL_USE_GPT                 FALSE
#endif

/**
 * @brief   Enables the I2C subsystem.
 */
#if !defined(HAL_USE_I2C) || defined(__DOXYGEN__)
#define HAL_USE_I2C                 TRUE
#endif

/**
 * @brief   Enables the I2S subsystem.
 */
#if !defined(HAL_USE_I2S) || defined(__DOXYGEN__)
#define HAL_USE_I2S                 FALSE
#endif

/**
 * @brief   Enables the ICU subsystem.
 */
#if !defined(HAL_USE_ICU) || defined(__DOXYGEN__)
#define HAL_USE_ICU                 FALSE
#endif

/**
 * @brief   Enables the MAC subsystem.
 */
#if !defined(HAL_USE_MAC) || defined(__DOXYGEN__)
#define HAL_USE_MAC                 FALSE
#endif

/**
 * @brief   Enables the MMC_SPI subsystem.
 */
#if !defined(HAL_USE_MMC_SPI) || defined(__DOXYGEN__)
#define HAL_USE_MMC_SPI             FALSE
#endif

/**
 * @brief   Enables the PWM subsystem.
 */
#if !defined(HAL_USE_PWM) || defined(__DOXYGEN__)
#define HAL_USE_PWM                 TRUE
#endif

/**
 * @brief   Enables the RTC subsystem.
 */
#if !defined(HAL_USE_RTC) || defined(__DOXYGEN__)
#define HAL_USE_RTC                 FALSE
#endif

/**
 * @brief   Enables the SDC subsystem.
 */
#if !defined(HAL_USE_SDC) || defined(__DOXYGEN__)
#define HAL_USE_SDC                 TRUE
#endif

/**
 * @brief   Enables the SERIAL subsystem.
 */
#if !defined(HAL_USE_SERIAL) || defined(__DOXYGEN__)
#define HAL_USE_SERIAL              TRUE
#endif

/**
 * @brief   Enables the SERIAL over USB subsystem.
 */
#if !defined(HAL_USE_SERIAL_USB) || defined(__DOXYGEN__)
#define HAL_USE_SERIAL_USB          FALSE
#endif

/**
 * @brief   Enables the SIO subsystem.
 */
#if !defined(HAL_USE_SIO) || defined(__DOXYGEN__)
#define HAL_USE_SIO                         FALSE
#endif

/**
 * @brief   Enables the SPI subsystem.
 */
#if !defined(HAL_USE_SPI) || defined(__DOXYGEN__)
#define HAL_USE_SPI                 TRUE
#endif

/**
 * @brief   Enables the TRNG subsystem.
 */
#if !defined(HAL_USE_TRNG) || defined(__DOXYGEN__)
#define HAL_USE_TRNG                        FALSE
#endif

/**
 * @brief   Enables the UART subsystem.
 */
#if !defined(HAL_USE_UART) || defined(__DOXYGEN__)
#define HAL_USE_UART                FALSE
#endif

/**
 * @brief   Enables the USB subsystem.
 */
#if !defined(HAL_USE_USB) || defined(__DOXYGEN__)
#define HAL_USE_USB                 FALSE
#endif

/**
 * @brief   Enables the WDG subsystem.
 */
#if !defined(HAL_USE_WDG) || defined(__DOXYGEN__)
#define HAL_USE_WDG                         FALSE
#endif

/**
 * @brief   Enables the WSPI subsystem.
 */
#if !defined(HAL_USE_WSPI) || defined(__DOXYGEN__)
#define HAL_USE_WSPI                        FALSE
#endif

/*===========================================================================*/
/* PAL driver related settings.                                              */
/*===========================================================================*/

/**
 * @brief   Enables synchronous APIs.
 * @note    Disabling this option saves both code and data space.
 */
#if !defined(PAL_USE_CALLBACKS) || defined(__DOXYGEN__)
#define PAL_USE_CALLBACKS                   TRUE
#endif

/**
 * @brief   Enables synchronous APIs.
 * @note    Disabling this option saves both code and data space.
 */
#if !defined(PAL_USE_WAIT) || defined(__DOXYGEN__)
#define PAL_USE_WAIT                        FALSE
#endif

/*===========================================================================*/
/* ADC driver related settings.                                              */
/*===========================================================================*/

/**
 * @brief   Enables synchronous APIs.
 * @note    Disabling this option saves both code and data space.
 */
#if !defined(ADC_USE_WAIT) || defined(__DOXYGEN__)
#define ADC_USE_WAIT                TRUE
#endif

/**
 * @brief   Enables the @p adcAcquireBus() and @p adcReleaseBus() APIs.
 * @note    Disabling this option saves both code and data space.
 */
#if !defined(ADC_USE_MUTUAL_EXCLUSION) || defined(__DOXYGEN__)
#define ADC_USE_MUTUAL_EXCLUSION    FALSE
#endif

/*===========================================================================*/
/* CAN driver related settings.                                              */
/*===========================================================================*/

/**
 * @brief   Sleep mode related APIs inclusion switch.
 */
#if !defined(CAN_USE_SLEEP_MODE) || defined(__DOXYGEN__)
#define CAN_USE_SLEEP_MODE          TRUE
#endif

/**
 * @brief   Enforces the driver to use direct callbacks rather than OSAL events.
 */
#if !defined(CAN_ENFORCE_USE_CALLBACKS) || defined(__DOXYGEN__)
#define CAN_ENFORCE_USE_CALLBACKS           TRUE
#endif

/*===========================================================================*/
/* CRY driver related settings.                                              */
/*===========================================================================*/

/**
 * @brief   Enables the SW fall-back of the cryptographic driver.
 * @details When enabled, this option, activates a fall-back software
 *          implementation for algorithms not supported by the underlying
 *          hardware.
 * @note    Fall-back implementations may not be present for all algorithms.
 */
#if !defined(HAL_CRY_USE_FALLBACK) || defined(__DOXYGEN__)
#define HAL_CRY_USE_FALLBACK                FALSE
#endif

/**
 * @brief   Makes the driver forcibly use the fall-back implementations.
 */
#if !defined(HAL_CRY_ENFORCE_FALLBACK) || defined(__DOXYGEN__)
#define HAL_CRY_ENFORCE_FALLBACK            FALSE
#endif

/*===========================================================================*/
/* DAC driver related settings.                                              */
/*===========================================================================*/

/**
 * @brief   Enables synchronous APIs.
 * @note    Disabling this option saves both code and data space.
 */
#if !defined(DAC_USE_WAIT) || defined(__DOXYGEN__)
#define DAC_USE_WAIT                        TRUE
#endif

/**
 * @brief   Enables the @p dacAcquireBus() and @p dacReleaseBus() APIs.
 * @note    Disabling this option saves both code and data space.
 */
#if !defined(DAC_USE_MUTUAL_EXCLUSION) || defined(__DOXYGEN__)
#define DAC_USE_MUTUAL_EXCLUSION            TRUE
#endif

/*===========================================================================*/
/* I2C driver related settings.                                              */
/*===========================================================================*/

/**
 * @brief   Enables the mutual exclusion APIs on the I2C bus.
 */
#if !defined(I2C_USE_MUTUAL_EXCLUSION) || defined(__DOXYGEN__)
#define I2C_USE_MUTUAL_EXCLUSION    TRUE
#endif

/*===========================================================================*/
/* MAC driver related settings.                                              */
/*===========================================================================*/

/**
 * @brief   Enables the zero-copy API.
 */
#if !defined(MAC_USE_ZERO_COPY) || defined(__DOXYGEN__)
#define MAC_USE_ZERO_COPY           FALSE
#endif

/**
 * @brief   Enables an event sources for incoming packets.
 */
#if !defined(MAC_USE_EVENTS) || defined(__DOXYGEN__)
#define MAC_USE_EVENTS              TRUE
#endif

/*===========================================================================*/
/* MMC_SPI driver related settings.                                          */
/*===========================================================================*/

/**
 * @brief   Timeout before assuming a failure while waiting for card idle.
 * #note    Time is in milliseconds.
 */
#if !defined(MMC_IDLE_TIMEOUT_MS) || defined(__DOXYGEN__)
#define MMC_IDLE_TIMEOUT_MS                 1000
#endif

/**
 * @brief   Mutual exclusion on the SPI bus.
 */
#if !defined(MMC_USE_MUTUAL_EXCLUSION) || defined(__DOXYGEN__)
#define MMC_USE_MUTUAL_EXCLUSION            TRUE
#endif

/*===========================================================================*/
/* SDC driver related settings.                                              */
/*===========================================================================*/

/**
 * @brief   Number of initialization attempts before rejecting the card.
 * @note    Attempts are performed at 10mS intervals.
 */
#if !defined(SDC_INIT_RETRY) || defined(__DOXYGEN__)
#define SDC_INIT_RETRY              100
#endif

/**
 * @brief   Include support for MMC cards.
 * @note    MMC support is not yet implemented so this option must be kept
 *          at @p FALSE.
 */
#if !defined(SDC_MMC_SUPPORT) || defined(__DOXYGEN__)
#define SDC_MMC_SUPPORT             FALSE
#endif

/**
 * @brief   Delays insertions.
 * @details If enabled this options inserts delays into the MMC waiting
 *          routines releasing some extra CPU time for the threads with
 *          lower priority, this may slow down the driver a bit however.
 */
#if !defined(SDC_NICE_WAITING) || defined(__DOXYGEN__)
#define SDC_NICE_WAITING            TRUE
#endif

/**
 * @brief   OCR initialization constant for V20 cards.
 */
#if !defined(SDC_INIT_OCR_V20) || defined(__DOXYGEN__)
#define SDC_INIT_OCR_V20                    0x50FF8000U
#endif

/**
 * @brief   OCR initialization constant for non-V20 cards.
 */
#if !defined(SDC_INIT_OCR) || defined(__DOXYGEN__)
#define SDC_INIT_OCR                        0x80100000U
#endif

/*===========================================================================*/
/* SERIAL driver related settings.                                           */
/*===========================================================================*/

/**
 * @brief   Default bit rate.
 * @details Configuration parameter, this is the baud rate selected for the
 *          default configuration.
 */
#if !defined(SERIAL_DEFAULT_BITRATE) || defined(__DOXYGEN__)
#define SERIAL_DEFAULT_BITRATE      38400
#endif

/**
 * @brief   Serial buffers size.
 * @details Configuration parameter, you can change the depth of the queue
 *          buffers depending on the requirements of your application.
 * @note    The default is 16 bytes for both the transmission and receive
 *          buffers.
 */
#if !defined(SERIAL_BUFFERS_SIZE) || defined(__DOXYGEN__)
#if defined(STM32H7) && HAL_MEMORY_TOTAL_KB>=512
#define SERIAL_BUFFERS_SIZE     512
#else
#define SERIAL_BUFFERS_SIZE     256
#endif
#endif

/*===========================================================================*/
/* SIO driver related settings.                                              */
/*===========================================================================*/

/**
 * @brief   Default bit rate.
 * @details Configuration parameter, this is the baud rate selected for the
 *          default configuration.
 */
#if !defined(SIO_DEFAULT_BITRATE) || defined(__DOXYGEN__)
#define SIO_DEFAULT_BITRATE                 38400
#endif

/**
 * @brief   Support for thread synchronization API.
 */
#if !defined(SIO_USE_SYNCHRONIZATION) || defined(__DOXYGEN__)
#define SIO_USE_SYNCHRONIZATION             TRUE
#endif

/*===========================================================================*/
/* SERIAL_USB driver related setting.                                        */
/*===========================================================================*/

/**
 * @brief   Serial over USB buffers size.
 * @details Configuration parameter, the buffer size must be a multiple of
 *          the USB data endpoint maximum packet size.
 * @note    The default is 256 bytes for both the transmission and receive
 *          buffers.
 */
#if !defined(SERIAL_USB_BUFFERS_SIZE) || defined(__DOXYGEN__)
#if defined(STM32H7) && HAL_MEMORY_TOTAL_KB>=512
#define SERIAL_USB_BUFFERS_SIZE     768
#else
#define SERIAL_USB_BUFFERS_SIZE     256
#endif
#endif

/**
 * @brief   Serial over USB number of buffers.
 * @note    The default is 2 buffers.
 */
#if !defined(SERIAL_USB_BUFFERS_NUMBER) || defined(__DOXYGEN__)
// more USB buffers works well on H7 and higher end F7
#if (defined(STM32H7) || defined(STM32F7)) && HAL_MEMORY_TOTAL_KB>=512
#define SERIAL_USB_BUFFERS_NUMBER   4
#else
#define SERIAL_USB_BUFFERS_NUMBER   2
#endif
#endif

/*===========================================================================*/
/* SPI driver related settings.                                              */
/*===========================================================================*/

/**
 * @brief   Enables synchronous APIs.
 * @note    Disabling this option saves both code and data space.
 */
#if !defined(SPI_USE_WAIT) || defined(__DOXYGEN__)
#define SPI_USE_WAIT                TRUE
#endif

/**
 * @brief   Inserts an assertion on function errors before returning.
 */
#if !defined(SPI_USE_ASSERT_ON_ERROR) || defined(__DOXYGEN__)
#define SPI_USE_ASSERT_ON_ERROR             TRUE
#endif

/**
 * @brief   Enables circular transfers APIs.
 * @note    Disabling this option saves both code and data space.
 */
#if !defined(SPI_USE_CIRCULAR) || defined(__DOXYGEN__)
#define SPI_USE_CIRCULAR                    FALSE
#endif

/**
 * @brief   Enables the @p spiAcquireBus() and @p spiReleaseBus() APIs.
 * @note    Disabling this option saves both code and data space.
 */
#if !defined(SPI_USE_MUTUAL_EXCLUSION) || defined(__DOXYGEN__)
#define SPI_USE_MUTUAL_EXCLUSION    TRUE
#endif

/**
 * @brief   Handling method for SPI CS line.
 * @note    Disabling this option saves both code and data space.
 */
#if !defined(SPI_SELECT_MODE) || defined(__DOXYGEN__)
#define SPI_SELECT_MODE                     SPI_SELECT_MODE_PAD
#endif

/*======# hwdef for Luminousbees flight board

# MCU class and specific type
MCU STM32F4xx STM32F427xx

# board ID for firmware load
APJ_BOARD_ID 11

# crystal frequency
OSCILLATOR_HZ 24000000

# ChibiOS system timer
STM32_ST_USE_TIMER 5

# flash size
FLASH_SIZE_KB 2048

env OPTIMIZE -O3

# serial port for stdout disabled, use USB console
# STDOUT_SERIAL SD7
# STDOUT_BAUDRATE 57600

# only one I2C bus
I2C_ORDER I2C1

# to match px4 we make the first bus number 1
define HAL_I2C_BUS_BASE 1
define HAL_I2C_INTERNAL_MASK 0

# order of UARTs (and USB)
SERIAL_ORDER OTG1 USART2 USART3 UART4 UART8 USART1 UART7

# UART4 is GPS
PA0 UART4_TX UART4
PA1 UART4_RX UART4 

# Battery & current control
PA2 BATT_VOLTAGE_SENS ADC1
PA3 BATT_CURRENT_SENS ADC1
PA4 VDD_5V_SENS ADC1 SCALE(2)

# SPI1 is sensors bus
PA5 SPI1_SCK SPI1
PA6 SPI1_MISO SPI1
PA7 SPI1_MOSI SPI1


PA11 OTG_FS_DM OTG1
PA12 OTG_FS_DP OTG1

PA13 JTMS-SWDIO SWD
PA14 JTCK-SWCLK SWD


PB2 BOOT1 INPUT
PB5 VDD_BRICK_VALID INPUT

# USART1 
PB6 TIM4_CH1 TIM4 PWM(7) GPIO(56)  # PB6 as led strip control
#PB6 USART1_TX USART1
PB7 USART1_RX USART1

# UWB DW1000
PB4 UWB_CS CS

PB8 I2C1_SCL I2C1
PB9 I2C1_SDA I2C1

# SPI2 is FRAM
PB10 SPI2_SCK SPI2
PB14 SPI2_MISO SPI2
PB15 SPI2_MOSI SPI2

PC0 VBUS_VALID INPUT
PC4 SAFETY_IN INPUT PULLDOWN

PC7 TIM8_CH2 TIM8 RCIN PULLDOWN LOW # also USART6_RX for serial RC

PC8 SDIO_D0 SDIO
PC9 SDIO_D1 SDIO
PC10 SDIO_D2 SDIO
PC11 SDIO_D3 SDIO
PC12 SDIO_CK SDIO
PD2 SDIO_CMD SDIO

# USART2 serial2 telem1 connected to ESP

PD4 BMI088_ACCEL_CS CS
PD3 BMI088_GYRO_CS CS
PD5 USART2_TX USART2
PD6 USART2_RX USART2

PD7 BARO_CS CS
# PB7 BARO2_CS CS	# FOR DPS310 ON FRAME MICRO

# USART3 serial3 telem2
PD8 USART3_TX USART3
PD9 USART3_RX USART3
PD10 FRAM_CS CS


PD13 TIM4_CH2 TIM4 PWM(5) GPIO(54)
PD14 TIM4_CH3 TIM4 PWM(6) GPIO(55)

# UART8
PE0 UART8_RX UART8
PE1 UART8_TX UART8

#set up SPI bus4 for UWB
PE2 SPI4_SCK SPI4
PE5 SPI4_MISO SPI4
PE6 SPI4_MOSI SPI4


# UART7 is debug
PE7 UART7_RX UART7 NODMA
PE8 UART7_TX UART7 NODMA

PE11 TIM1_CH2 TIM1 PWM(1) GPIO(50)     #52
PE14 TIM1_CH4 TIM1 PWM(2) GPIO(51)     #50
PE9 TIM1_CH1 TIM1 PWM(3) GPIO(52)      #53
PE13 TIM1_CH3 TIM1 PWM(4) GPIO(53)     #51


# SPI device table. The DEVID values are chosen to match the PX4 port
# of ArduPilot so users don't need to re-do their accel and compass calibrations
# when moving to ChibiOS
 SPIDEV ms5611_int  SPI2 DEVID3  BARO_CS    MODE3  20*MHZ  20*MHZ
SPIDEV bmi088_g    SPI4 DEVID1  BMI088_GYRO_CS    MODE3 10*MHZ 10*MHZ
SPIDEV bmi088_a    SPI4 DEVID2  BMI088_ACCEL_CS   MODE3 10*MHZ 10*MHZ
SPIDEV ramtron     SPI2 DEVID10 FRAM_CS    		MODE3   8*MHZ   8*MHZ
SPIDEV dwm1000     SPI4 DEVID5  UWB_CS     		MODE0   3*MHZ  20*MHZ
define HAL_CHIBIOS_ARCH_FMUV4 1

define HAL_STORAGE_SIZE        16384

# enable RAMTROM parameter storage
define HAL_WITH_RAMTRON 1

# enable FAT filesystem
define HAL_OS_FATFS_IO 1

# pixracer has 3 LEDs, Red, Green, Blue
define AP_NOTIFY_GPIO_LED_RGB_ENABLED 1

# LED setup for PixracerLED driver
PB11 LED_RED   OUTPUT GPIO(0)
PB1  LED_GREEN OUTPUT GPIO(1)
PB3  LED_BLUE  OUTPUT GPIO(2)

define AP_NOTIFY_GPIO_LED_RGB_RED_PIN 0
define AP_NOTIFY_GPIO_LED_RGB_GREEN_PIN 1
define AP_NOTIFY_GPIO_LED_RGB_BLUE_PIN 2

# enable RTSCTS
define AP_FEATURE_RTSCTS 1

# battery setup
define HAL_BATT_VOLT_PIN 2
define HAL_BATT_CURR_PIN 3
define HAL_BATT_VOLT_SCALE 10.1
define HAL_BATT_CURR_SCALE 17.0

# setup serial port defaults for ESP8266
define DEFAULT_SERIAL5_PROTOCOL SerialProtocol_MAVLink2
define DEFAULT_SERIAL5_BAUD 921600

# Set one or two IMUs
#IMU Invensense SPI:icm20608 ROTATION_YAW_180
IMU BMI088 SPI:bmi088_a SPI:bmi088_g ROTATION_ROLL_180_YAW_90
define HAL_DEFAULT_INS_FAST_SAMPLE 1

# 2 compasses. R15 has LIS3MDL instead of HMC5843
COMPASS HMC5843 SPI:hmc5843 false ROTATION_PITCH_180
COMPASS LIS3MDL SPI:lis3mdl false ROTATION_NONE

# also probe all types of external I2C compasses
define HAL_PROBE_EXTERNAL_I2C_COMPASSES

# Barometer ( DPS310 under test on micro frame )
BARO MS56XX SPI:ms5611_int
# BARO DPS310      SPI:dps310

# reserve plenty of memory for DMA for LED buffers
define DMA_RESERVE_SIZE 32768

# bootloader embedding / bootloader flashing not available
define AP_BOOTLOADER_FLASHING_ENABLED 0
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       AHRS_GPS_USE,2
AHRS_ORIENTATION,6
ANGLE_MAX,4500
ARMING_CHECK,13822
ATC_ACCEL_P_MAX,200000
ATC_ACCEL_R_MAX,200000
ATC_ACCEL_Y_MAX,50000
ATC_ANG_PIT_P,18
ATC_ANG_RLL_P,18
ATC_ANG_YAW_P,10
ATC_RAT_PIT_D,0.003
ATC_RAT_PIT_FLTD,50
ATC_RAT_PIT_FLTT,25
ATC_RAT_PIT_I,0.14
ATC_RAT_PIT_P,0.14
ATC_RAT_RLL_D,0.003
ATC_RAT_RLL_FLTD,50
ATC_RAT_RLL_FLTT,25
ATC_RAT_RLL_I,0.14
ATC_RAT_RLL_P,0.14
ATC_RAT_YAW_D,0
ATC_RAT_YAW_FLTD,50
ATC_RAT_YAW_FLTE,3.7
ATC_RAT_YAW_FLTT,25
ATC_RAT_YAW_I,0.05
ATC_RAT_YAW_P,0.5
AUTOTUNE_AGGR,0.075
AUTOTUNE_MIN_D,0.0003
AVOID_ENABLE,0
BATT_AMP_OFFSET,0
BATT_AMP_PERVLT,4.6135
BATT_ARM_MAH,0
BATT_ARM_VOLT,7.2
BATT_CAPACITY,3400
BATT_CRT_MAH,0
BATT_CRT_VOLT,6
BATT_CURR_PIN,15
BATT_FS_CRT_ACT,1
BATT_FS_LOW_ACT,2
BATT_FS_VOLTSRC,0
BATT_LOW_MAH,0
BATT_LOW_TIMER,10
BATT_LOW_VOLT,6.2
BATT_MONITOR,4
BATT_OPTIONS,0
BATT_SERIAL_NUM,-1
BATT_VOLT_MULT,3.28
BATT_VOLT_PIN,14
BRD_SAFETYENABLE,0
BRD_SAFETYOPTION,0
BRD_SAFETY_DEFLT,0
CAN_D1_PROTOCOL,0
CAN_D2_PROTOCOL,0
COMPASS_AUTODEC,1
COMPASS_EXTERNAL,1
COMPASS_ORIENT,12
COMPASS_DISBLMSK,510846
COMPASS_USE2,0
COMPASS_USE3,0
COMPASS_CAL_FIT,16
DISARM_DELAY,10
EK3_IMU_MASK,1
EK3_POSNE_M_NSE,0.1
EK3_SRC1_POSXY,3
EK3_SRC1_POSZ,3
EK3_SRC1_VELXY,3
EK3_SRC1_VELZ,3
EK3_SRC3_POSZ,1
EK3_ALT_M_NSE,2
ESC_CALIBRATION,9
FLTMODE3,2
FLTMODE4,2
FLTMODE5,5
FLTMODE6,5
FRAME_CLASS,1
FRSKY_DNLINK1_ID,-1
FRSKY_DNLINK2_ID,-1
FRSKY_DNLINK_ID,-1
FRSKY_UPLINK_ID,-1
FS_OPTIONS,20
FS_THR_ENABLE,0
FS_VIBE_ENABLE,0
FENCE_ENABLE,1
GND_EFFECT_COMP,0
GPS_AUTO_SWITCH,0
GPS1_GNSS_MODE,0
GPS1_RATE_MS,140
GPS1_SBAS_MODE,0
GPS1_TYPE,2
GPS_MIN_ELEV,15
INS_ACC_BODYFIX,1
INS_ACCEL_FILTER,10
INS_ENABLE_MASK,1
INS_FAST_SAMPLE,1
INS_GYRO_FILTER,80
INS_GYRO_RATE,2
INS_HNTC2_ATT,16
INS_HNTC2_BW,50
INS_HNTC2_ENABLE,0
INS_HNTC2_FREQ,103
INS_HNTC2_HMNCS,1
INS_HNTC2_MODE,0
INS_HNTC2_OPTS,0
INS_HNTC2_REF,0
INS_HNTCH_ATT,40
INS_HNTCH_BW,8
INS_HNTCH_ENABLE,1
INS_HNTCH_FREQ,40
INS_HNTCH_HMNCS,22
INS_HNTCH_MODE,3
INS_HNTCH_OPTS,22
INS_HNTCH_REF,1
INS_LOG_BAT_CNT,32
INS_LOG_BAT_OPT,2
LAND_ALT_LOW,500
LAND_SPEED,80
LAND_SPEED_HIGH,300
LOG_BITMASK,141310
LOG_FILE_DSRMROT,1
LOIT_SPEED,2000
MOT_BAT_VOLT_MAX,7.56
MOT_BAT_VOLT_MIN,5.2
MOT_HOVER_LEARN,1
MOT_PWM_MAX,2000
MOT_PWM_MIN,1000
MOT_PWM_TYPE,6
MOT_SPIN_ARM,0.05
MOT_SPIN_MIN,0.16
MOT_THST_EXPO,0.55
MOT_THST_HOVER,0.47
NTF_BUZZ_TYPES,1
NTF_LED_BRIGHT,1
NTF_LED_TYPES,1
PSC_ACCZ_I,0.94
PSC_ACCZ_P,0.47
PSC_JERK_XY,6
PSC_JERK_Z,6
PSC_POSZ_P,1
RC1_MAX,1900
RC1_MIN,1100
RC2_MAX,1900
RC2_MIN,1100
RC3_MAX,1900
RC3_MIN,1100
RC4_MAX,1900
RC4_MIN,1100
RC6_OPTION,5
RC_PROTOCOLS,0
RTL_ALT,1500
SCHED_LOOP_RATE,800
SERIAL1_BAUD,921
SERIAL1_PROTOCOL,2
SERIAL2_OPTIONS,8
SERIAL2_PROTOCOL,2
SERIAL4_BAUD,115
SERIAL4_PROTOCOL,16
SERIAL5_BAUD,921
SERIAL5_PROTOCOL,-1
SERIAL6_BAUD,921
SERIAL6_PROTOCOL,-1
SERVO1_FUNCTION,33
SERVO1_MAX,2000
SERVO1_MIN,1000
SERVO1_TRIM,1500
SERVO2_FUNCTION,34
SERVO2_MAX,2000
SERVO2_MIN,1000
SERVO2_TRIM,1500
SERVO3_FUNCTION,35
SERVO3_MAX,2000
SERVO3_MIN,1000
SERVO3_TRIM,1500
SERVO4_FUNCTION,36
SERVO4_MAX,2000
SERVO4_MIN,1000
SERVO4_TRIM,1500
SERVO_BLH_AUTO,1
SERVO_BLH_BDMASK,15
SERVO_BLH_POLES,12
SERVO_BLH_TRATE,0
SERVO_DSHOT_ESC,1
SERVO_DSHOT_RATE,2
SERVO_BLH_RVMASK,3
SHOW_CTRL_MODE,1
SHOW_CTRL_RATE,10
SHOW_GROUP,0
SHOW_LED0_CHAN,1
SHOW_LED0_COUNT,100
SHOW_LED0_GAMMA,2.2
SHOW_LED0_TYPE,1
SHOW_MAX_XY_ERR,3
SHOW_MODE_BOOT,2
SHOW_PRE_LIGHTS,2
SHOW_START_AUTH,0
SHOW_SYNC_MODE,1
SHOW_TAKEOFF_ALT,2.5
SHOW_VEL_FF_GAIN,1
SR1_EXT_STAT,0
SR1_EXTRA1,0
SR1_EXTRA2,0
SR1_EXTRA3,0
SR1_POSITION,0
SR1_RAW_SENS,0
SR1_RC_CHAN,0
SRTL_POINTS,0
TERRAIN_ENABLE,0
WP_YAW_BEHAVIOR,0
WPNAV_ACCEL,300
WPNAV_ACCEL_Z,300
WPNAV_JERK,6
WPNAV_SPEED,1000
WPNAV_SPEED_DN,300
WPNAV_SPEED_UP,300
                                                                                                                                                                                                                                                                                                                                                                                                                                       # LUMINOUS BEE 5.32/5.4
# hw definition file for processing by chibios_hwdef.py
#define new bootloader baudrate

define BOOTLOADER_BAUDRATE 921600

# MCU class and specific type
MCU STM32H7xx STM32H743xx

# board ID for firmware load
APJ_BOARD_ID 1029

# crystal frequency
OSCILLATOR_HZ 24000000

# flash size
FLASH_SIZE_KB 2048

# bootloader is installed at zero offset
FLASH_RESERVE_START_KB 0

# the location where the bootloader will put the firmware
# the H743 has 128k sectors
FLASH_BOOTLOADER_LOAD_KB 128

# only one I2C bus
I2C_ORDER I2C1

define HAL_I2C_INTERNAL_MASK 0

# order of UARTs (and USB) for bootloading
SERIAL_ORDER USART2 OTG1

# USART2 serial2 telem1


PD5 USART2_TX USART2
PD6 USART2_RX USART2

# UART7 is debug
PE7 UART7_RX UART7 NODMA
PE8 UART7_TX UART7 NODMA

# pins that USB is connected on.
PA11 OTG_FS_DM OTG1
PA12 OTG_FS_DP OTG1

# These are the pins for SWD debugging with a STlinkv2 or black-magic probe.
PA13 JTMS-SWDIO SWD
PA14 JTCK-SWCLK SWD

# CS lines
#PB4 UWB_CS CS
PC2 BMI088_ACCEL_CS CS
PC15 BMI088_GYRO_CS CS
PD7 BARO_CS CS
PE15 MAG_CS CS

PB11 LED_BOOTLOADER  OUTPUT
define HAL_LED_ON 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # hw definition file for processing by chibios_hwdef.py
# for MindPX-v2 hardware bootloader

# MCU class and specific type
MCU STM32F4xx STM32F427xx

define HAL_CHIBIOS_ARCH_MINDPXV2 1

# board ID for firmware load
APJ_BOARD_ID 88

# crystal frequency
OSCILLATOR_HZ 8000000

STM32_ST_USE_TIMER 5


# flash size
FLASH_SIZE_KB 2048

# location of application code
FLASH_BOOTLOADER_LOAD_KB 16

# bootloader loads at start of flash
FLASH_RESERVE_START_KB 0

# order of UARTs (and USB)
SERIAL_ORDER OTG1 USART2

PA9 VBUS INPUT

PA11 OTG_FS_DM OTG1
PA12 OTG_FS_DP OTG1

PA13 JTMS-SWDIO SWD
PA14 JTCK-SWCLK SWD

# USART2 serial2 telem1
PD5 USART2_TX USART2
PD6 USART2_RX USART2

PA8 LED_BOOTLOADER OUTPUT
define HAL_LED_ON 1


# Add CS pins to ensure they are high in bootloader
PB2 GYRO_CS CS
PC15 BARO_CS CS
PD11 ACCEL_MAG_CS CS
PE3 MPU_CS CS
PE12 FRAM_CS CS
PE15 NRF_CS CS
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           # ModalAI Flight Core v1 Controller

The [ModalAI](http://www.modalai.com/) FlightCore is a flight controller made in the USA. 
The Flight Core can be paired with ModalAI VOXL for obstacle avoidance and GPS-denied navigation, or used independently as a standalone flight controller.

Buy [Here](https://www.modalai.com/products/flight-core)

See Flight Core Documentation [Here](https://docs.modalai.com/flight-core/)

See Flight Core Datasheet [Here](https://docs.modalai.com/flight-core-datasheets/)

![ModalAI_FC](flight-core.jpg "modal-fc")

## Features

| Feature          | Details                                                                                                                                                         |
|:-----------------|:----------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Weight           | 6 g                                                                                                                                                             |
| MCU              | 216MHz, 32-bit ARM M7 [STM32F765II](https://www.st.com/en/microcontrollers-microprocessors/stm32f765ii.html)                                                    |
| Memory           | 256Kb FRAM                                                                                                                                                      |
|                  | 2Mbit Flash                                                                                                                                                     |
|                  | 512Kbit SRAM                                                                                                                                                    |
| IMUs             | [ICM-20602](https://www.invensense.com/products/motion-tracking/6-axis/icm-20602/) (SPI1)                                                                       |
|                  | [ICM-42688-P](https://invensense.tdk.com/products/motion-tracking/6-axis/icm-42688-p/) (SPI2)                                                                   |
|                  | [BMI088](https://www.bosch-sensortec.com/bst/products/all_products/bmi088_1) (SPI6)                                                                             |
| Barometer        | [BMP388](https://www.bosch-sensortec.com/bst/products/all_products/bmp388) (I2C4)                                                                               |
| Secure Element   | [A71CH](https://www.nxp.com/products/security-and-authentication/authentication/plug-and-trust-the-fast-easy-way-to-deploy-secure-iot-connections:A71CH) (I2C4) |
| microSD Card     | [Information on supported cards](https://dev.px4.io/v1.9.0/en/log/logging.html#sd-cards)                                                                        |
| Inputs           | GPS/Mag                                                                                                                                                         |
|                  | Spektrum                                                                                                                                                        |
|                  | Telemetry                                                                                                                                                       |
|                  | CAN bus                                                                                                                                                         |
|                  | PPM                                                                                                                                                             |
| Outputs          | 6 LEDs (2xRGB)                                                                                                                                                  |
|                  | 8 PWM Channels                                                                                                                                                  |
| Extra Interfaces | 3 serial ports                                                                                                                                                  |
|                  | I2C                                                                                                                                                             |
|                  | GPIO                                                                                                                                                            |


## Pinout

![ModalAI_v1 Board](fc-overlay-top-144-dpi.jpg "ModalAI_v1")

For detailed pinout descriptions see [FlightCore Pinout](https://docs.modalai.com/flight-core-datasheets-connectors/)

## Dimensions

![ModalAI-fc-dims](flight_core_v1_imu_locations.png "modal-fc-dims")

![ModalAI_fc-dims2](flight-core-dims.png "modal-fc-dims2")

## Block Diagram

![ModalAI_FC](fc-dk-preliminary-datasheet.png "modal-fc-block")

## UART Mapping

The UARTs are marked Rn and Tn in the above pinouts. The Rn pin is the
receive pin for UARTn. The Tn pin is the transmit pin for UARTn.

 - SERIAL0 -> USB
 - SERIAL1 -> UART7 (Telem1)
 - SERIAL2 -> UART5 (Telem2)
 - SERIAL3 -> USART1 (GPS)
 - SERIAL4 -> UART4 (GPS2)
 - SERIAL5 -> USART2
 - SERIAL6 -> USART6 (spektrum RCIN)
 - SERIAL7 -> USART3
 - SERIAL8 -> USB2

## RC Input

RC input is configured on both the PPM input pin and the "spektrum"
USART6 UART. The PPM pin supports all one-way RC protocols. For
protocols requiring half-duplex serial to transmit telemetry (such as
FPort) you should use the spektrum port, mapped to SERIAL6. Both PPM
and spektrum ports are enabled for RCIN by default.

## PWM Output

The ModalAI_v1 supports up to 8 PWM outputs on the PWM output connector

The PWM is in 2 groups:

 - PWM 1, 2, 3, 4 in group1
 - PWM 5, 6, 7, 8 in group2

Channels within the same group need to use the same output rate. If
any channel in a group uses DShot then all channels in the group need
to use DShot.

## Power Monitoring

In addition to the normal range of ArduPilot power monitoring options,
the modalAI build supports two I2C power monitors, the INA231 and the
LTC2946. The FlightCore board comes with the INA231 and you should set
BATTERY_MONITOR to 21. For the LTC2946 based power brick you should
set BATTERY_MONITOR to 22.

## Compass

The ModalAI_v1 does not have a built-in compass, but you can attach an
external compass

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         PNG

   IHDR  f  6   'u  JiCCPICC Profile  HWTS[RIhH		RK	E*I D
]D@]U] kE]]*oR@=ssg I> "YRt8kbF&0`t;0Rvbb2]^ P I8[ B|  /@zERTs5L5Zmx7 d'@Y\{b@,@q_@*S<r&#rioY-!D$Un0^Iv|T"&UcX3C(IA|V#BWZ".h.#uI	C8Gak6dj*STHU*JIQiB'jl0R'~FHRoqPBP5E-n>O	B	;uG(7@,j$D=ND6s" 5x(1E'/q" (`Aw_(2Mg2(B$yQ!(ZG3#A,(Yaoiw;Z j:6i5!^%1A!Fq3<36/=p$&^$*C6/s C~3q3x(m[_T]kG03u]t}YT5BX?J`%N`X`aV"vDWU4-IO>OSUIGGXD?t,8WTb_JX^ #m%S}@?S}k :+p;{U|XU=FK``>^0	2TXe\20A9+:P6`'-08~ep<}5@bX!+#!H$$!HH2YT"dBN N6 A^ QFFQ6S\tZj6'uT>E1`Ls1eb9U`UX=*zw8g,<3y27D	@0KI('TNH$2D?6f{.b?D2%I	$TN@M:FB&%^(r&YB^D""%_!?&P)@JE@EYAFi\tSTGj05G]H6QOSR_L,sV;!M)hi;hii/t=I//7O2tuWtQzSJ];syk7`x$,3ep!0P`Xfac28>c1c4hh534xqqqc%c:0
>###hqe&a&B
=&ML#MMW3\&4dvw#5w1O2myEbI^KeeZ=V+ZcVYlVugmncba=`hjf=[mZv>;+vs~CGGcc]'SzkDg|]PK%WUsaT(Q7hnlbFL8E-Fj<|<
<y47;{w1cc6OG_?_oo__M#Deg,
W[P~'c
nlad|>m{vfw{rrG`5lr}gG!q~;KM}'k7~MXp/1qF'Nx4'L2#yZ))+R:*R&5IH_8z22"'=grSL97lj#"dgKu}|= LV#>	Y$78wMn(TT%s5y1y',H/SH.*<$1KNM^2S*-*gX7O+.GSEF~QF8KJ$%gZ:qiTs,`.{yym^`B.Xz,u}McnAn^//XtOU,XbJJBW\mtukV}nsUc6WWVUnrQ=uuKll)lSf/-U[[>?4l7^vZ6*{vO}[a*SO7kHQ5CmAmvyaG8J=ZvtX'rOtOksrk&8{/Q<>sl:>K~Z/\nyJW#r{7Ro9Vw	w+o~_Uyw]OQcO?Jig3g
b/4}W_xSwOx`>~;X88(x  3 `\I{ZTZ|h9^@nTG0z{7s4\4x!|i `op|~"|BMWoY|"   	pHYs  %  %IR$  iTXtXML:com.adobe.xmp     <x:xmpmeta xmlns:x="adobe:ns:meta/" x:xmptk="XMP Core 5.4.0">
   <rdf:RDF xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#">
      <rdf:Description rdf:about=""
            xmlns:exif="http://ns.adobe.com/exif/1.0/">
         <exif:PixelXDimension>1382</exif:PixelXDimension>
         <exif:PixelYDimension>1590</exif:PixelYDimension>
      </rdf:Description>
   </rdf:RDF>
</x:xmpmeta>
|   iDOT            (       @ IDATxwJb;*vEc7'11&5X;"b`Ah^/wq Mg_b
XVU*`
XVU*`
XkLkLk{"U*`
XVU*`
XVU*``VU*`
XVU*`
XVU*`vnOg
XVU*`
XVU*`
X,u*`
XVU*`
XVU*`
a,]YVU*`
XVU*`
XVfm
XVU*`
XVU*`
XkXftVU*`
XVU*`
XVU`I0[XVU*`
X@.$@0B/~@?\9(`011CX]<TToZ)U]t-}.n^>Z>W/X.^'LBC/1WVRju>-?}j>	 Txne;A/kOdU*`Df=Fb
XVU`=P ~&>;U`VPVkSfaV<! N!D00B.!}a2Y[x"ywx2Wx^|D=*-\K^V)dDJ715=[f Vpnj wZ_\n	C_.0da4z#
5MjFl3\+]9YKfbWx:>C$GYTba=eB*VbU*`
X0	&*`
XV@T@VK' ,7kc ~M6!cH`-1yg'^0wgmF'$*8M	'nf-f@gm]1%JAQ`=\biv|,_^HEgP}%R~zUNN	YA`(Vvv<L|%Y.249^UD&?h4_i4-#GyI]VU)`l+ U*`
XTj Ba`p Hp^6>DJJQQQ?@hg/HEJ1$4 @WZOxe]V-><JgpT|0W-fyvW>s	y:tR[DJ#br._jl-J#UT*QV,z-#"Zi%+K &O2PhnjB(m6*"EY7IU*`
t,4Eab
XVU+ 0K@` -]+#=f/&`a}#z }n*Y4*Z~
ElIEEpKkg\(u"%,*JI-vt~Ss,f`b6?4sRo^1}jji?ZIOi+[Od.U=`%TgM
x%)XnWC^r f&FMpMF*7-F}1]A.K3N~9.VU*	`MU*`
XV@0 e2K80>7'fB "(g3sfxH%WY %b9P=|F9-f
&`fl1pn* E_AW_~q~p;gMW~ew_p\EVAYmU.W30d@|'-8=*`
X:vBI
XVU*94o|3E0OalMAjD8 1-+c#aSKzU\:uii08]@f[4>ZO1lDyb@2^\8::wHTe,<^zACS/4g|F0N>vAVe;[)XVGfmM
XVU*`XEfU3IjZSD0 0.7zMAaS=:4p&q3SKV1+e\+<jtjFcW=<,c;<w[zvKROs
Y&i<wM2j$5{;tz6 mla/cs~<1u{3EFL/Rf
XV`+%m<VU*`
XyrtD `>H0K8<s9rx[;C6MCnQ@$\)f=[4n<K%~G@^.[2s,K[wdJ_Y7Kl/7-^|c]	X6&!7<?;X[@P7z.e_Wr
kfL_fi/%b6v?QmMs0Q>8}03*72&+TyVU]f_VU*`
XV@8 I & |C,[^3f|reG|

AIn1X>`|#|XeC0KIGeEuvXr-c1c*z~U8M qU(%X~gnLm Yrzc$0/0t=Yh==(1{{5P:@Y0'][$b_7_}acEbru0J?U*`X`v*/ZU*`
X?9dsi
W_;re[1dPlnl5|$.H f(DjvC:\2JU2uF?KiD#t&DPQQ 0!emmmG(H=i<GI,mdR)/D>O\.xyN5L jl6k|R]J's <"ZZZL"eZW"Igr,Rq:"4<I_<n^tt-
Yp[1k'd24Q>sLcA^cmdJ\8Ey7@YPyS8yE+8c	S4Esv_seL<TmZ6f9huc)5Kbt/*B1;b+&y<+3s6< >FeV'fW^<6U*`A`*`
XVZ :v)VkZLp@M6m:1n|8"1"Q]bVMk^N	
	`d,B210PZZ[P
$|Jm,Fb12 J0St"X()2f	~k2@iii{zI	X_n^pYl/%M&W)9+0y/OV}"+`Kt3
!A%UMiZ1)cPr ($N'Q((0i9}nJK
+/Z}jS82.P-(- T
1T0+[r:~/e@q<':7+_XeP~r-e|yarAx?}q$84 `t@>bD]xcLU*`
),]SJXVU*`X;ZMGJ=1y9|P/2lPZ
fY=q{Ms<K
xX=	ofE6'x[L@WR,F:SyKY20!T:&	V@SSW-& k4={okE	VZVVV*K_/K&x)pYUYEh,Wy#ar S0SGF68a1+A,h$h \sSeeXdbs11s RY>! ^_d,#zw''--)5`Xjl6Ut*)~tiY)%KiZfwec1ytzQ<J^Q*D( |Zy)!p[Wk'"'/a%	sB(xJdr?8E0e`ve
X?[VU*`XukJMG0[[	+p#5`L-UA.76l"h*KQVSa4kk^XO$%Fto@+SYIGW5l[V cVBi,@dqmrEa>r	'DB_DHmnn2t`oKKU" SVWH;B<"5)+//jx^c'3<

tWy3uk N XaCZ*USiZf&eo"etF9dDue)8dUxJ iUUR% /u3tU:VkjSuu-d%p7=W%wYeVKG.@>sL6yg~_`Fo~=%^2#:t=0H$.3 f`vaXVN(lBVU*`
tvH<Vb+!C},f	E`Vqx0n!Dz&d1aRH%><2_K`VjpV.!or5i,h#W,-t%nQI[ (h)(`E WiUk]3(YGY,P0~~]FXv\.l"&_rpY+1(iT.Vju.((`
:,g3ZZ>e]eZAKJO]%&4%?_Y5XU^<	t7TyrU.h"C:l;XxTmU`{(+-LEuN&L?Ir+6|3mq1.:l(z*^7#cv|YJcvI0KWCa.$VU*`sMU*`
XVN@*YYLOFp,ffe1K0&-f9* ZM44q`V3/JEw n9%^VT5<|vf	fn9e6`@cWR#hm!/,LK!jhfmf  j31sLA6	t3	e;x`XUOx<[LSfYv74/0Ze8AGc"M}xMM-M~eI|
2<y*jkknv-]xI"n->	6w\L67uk7_?hz,|Cw	V V[`ZuDe`yKBQze{|rX4<;+M$HcYp7`|W_+S&M~q#GAC&!+tfF'>f72>f0)v>b
XFf;MQXVU*`
@9!{/0;h1;;iYteZY/p+nEYC:Dv1b);Y&U,UN1zi<"ssqoS\uxyK7\l 2[`Q=pg`[8G_XlSz=j4j9]dW8|-#-cikIz6zam#:{a <wA cSF0nO>L'.#= #V[=o$tw$N>l0i_v[n5F1v9_w'ON;D/CK0n8l~-n__|s=:u*~aq3+M iuy!0|c.`1kCcI[Cw(L,KWPWo8P9x<?s|Wxq8>{?Z\t=zJ+	eU]%3I5;`kYIa
XkFf,VU*`
X~>kD,z[1%-r-B%5D`@`vs}H$,f&^1,}8CBk}7d15oys&"V<{83p#$z$Wlj2t]T
v!\cuM7_prZr*GC,{3<|YgEiiFcZ (s>?G8?h\HmN;Dpy2^W]lpU-7sa@wkC+qeb3'Nw>n\v{k\p9r(qMW\E+B9Aub	dl0'M7@k0a7gywq'>&H@W Vqn$N>	 >#b_!A
&pBStMoC	(n/DgE8vgox&N|?p?7W\a,3/<v9d|k+Q;GT~d1;u-fMc
XEfZ6U*`
XVYJ"%e5` Yn+0K?	q-fhc1AB$zY}_jMZ"GfJ`OR[&_X0o-5wAH-=gO>gfH04%p.L*<^oNyP	'@HyRz+^~ejAC'?	NdXfWahqTZN0$+GO|3{6$<i}_owN+	of*$	%Gt o5tlK0,:"[br qZZcw-z]vPY0|q`7+2T?K&y$A{.<o-~_=(~iw7mg}n^N2\ZS[n?$o+.f.$TIu=.w(V2P8Lyc}ygh6;N96/?~7y.<|SN^G#	g$zQ}/YIf[V@fBY
XVU*.9iY1F3<PYNl3f7*2p,lbL>&i%/N"nZ~:pvEVi}.,*h?ojiz.4$=`ynA$UG"AZ 7&g+'/:DR+o_BanVx70=e)M}~M/N;WzS%g#[t0.RcJx*{}}xO{n
v3n.<'+Z0Ucpr/5eiB-.qSO;;rvwyg|QGr d@V>k}%>>v!C@~g	Tc]Kp[9Gn8_b&?7ZLy=?'6ij~gaaG6`6@	?mwMEPWp!WGWqkYrWf'l/eY<?c8~27>p*9w~mgSpY^6OfC`YsWy0l<VU*6^ce7w
X:'tp2wk
EUf7^O\U?
M>-Vnwu~c1|KvlbeX:>fdC$,}>f^r!0N3XDJQOI_V53O+Z	=wVV.+{<`0 h+@I/B?Jmu~n,"e5O{(<H}p	G!J&>
_ nnOAuM	9i?> p"+maK	T@~NLL0 zva<pp13gi*}h]_A}G8*,0Yw@=	hj55]P]of7^z)>{@!O{{"y'Zv}p/gw'a^=pWamDyxo Z^Qm,6	+*T1~-Yueg8\Lved/%*@8`Gm,4d|@UW'|"w'<~GMiZ"Ayu_V=,f_s	f+E
j]$*]VU`*`*Kz4OX	}('w@sUc"V4zQ26U@^j@j<WQkfn1so~Qf	(L_.0;cvWB2%Y6AnB[x<W/P
YlFoYj?UY&	-k'1/	`#=]'<{5,abYe3;5W_G5gnOxh5 880s|h3>nm
sE8cQU)?BS8^m}:l(N3?dV=W"*JxM{?<If(G>^3@%d(3qt-\ nA!V=?Wo]PTyQ^U-cN=-gOe_^0)8J)`OcN>=p?1#?GqEgq0d=q7cH*k_Nc;xt!9>:.-dPVVB9s&0l_{c=YaAY/{> 91`:	)*]vNshe=aesbBU C)K&zq3+lBYimo.VU*)`SMU`
,2!}6v?eRi'Wvr|J]:*'G:*JY{~hLhiWDA]ji\,"SF9Yf3B}7Tu8s[E Vu@"ffOH_7{Vu GzbT7J,Ymk,%U2[gd*YXLQf#93|x	mw`Zoii9``osFMq.@S\1cpdK~xWP/8"W'2~?pjqh){:qWHi3^<n3NM F%x$]Na^eJz}o`}<raL'qUW%9:'NHM6)O3;K
[_<{%d89 l7o2pl1uc=g+:W^\uEx}pBr]x=w?CM&zAk1oZNC/Nn{y	SL${TGwsZeS1Zh+n_hR/
+!dN{gYE\Pmk:@MdC1NFr.>
x^PumMw+}Av
XVN(lBQ@)wqk<=(kUKUtL-O3(*xH?cii	LXH{*b"f}~vU:i>YcmcU ofWXF?mA

Ywb_ 6H9jb aluhQlINZ/0aP'Myx-as{!q!$]'sb!?V	O85}~O?>O6 $Vc	cFA=|].>eUi}}3\\JJb8p:-R{t2r-_0#9)Vy,d^3[#6x#TDidClvqwtS+ZgH_k8w(LaPP: f|	&Mn:@uE`v?|N.9lX]9]=p//w};G(6M{o^y33,`$1(/e7@E7ll4)gcN5j(rtQBycM*7,_%%%OA:BM&N|(UvE	b|-c6L$/ofc
X:v
VtCc@,\k;eGZ
n,Stu
{&H9`{FabJRi,s}N8"XAbvsX	$;UCtaiq?`VEf}Y,]aIp`V"X!_'RVdM.5Bws3+V-9xG+e	;$vYnfO<nIW_~);B<?{mI};o'S&'@?Y_&p	VYHlWNEOw~_7's6x1;w7x_ZvoAw~a#-\A}|I0k.]z7JW	trvP;Ei!\q)1x}?v'zm:%Z[kjD8Yz\r	| .apO	>:0{~~xm*6 <_Qxs/7Iq0|8-|P\q)>~c1ep}Fnf&?hmzIVX0|M{
r2DAowaHsf8^>4:$&+G/Meu{V@gW^B6}V)_I/`sRYd|5
$d2q6K'S-O<M{3@t=642Rj_qX7Qz,K@*L!(W)?-CPUp:nJz
*Wb/'fWXF?,PYo
n}U"@4$ZMEHE%0f_74n*k!aw}/?$Cg{>iuU7aH~8DBhkn#S=LwGL}TUW;Wfk##o|m[o+v[!3AKTMj	
~gp_\>=#GtK+YJk%]I/@>UC?'?N6/kI{H7'M6I[|;8Gvxo~+|^_e{w/. oM[7~sY^0zm
7z6E4J
1	|}h%~sn`'E'e8CP_{z<t0~{O8HSU9t*/D{T57]pU2~CYFK`/ r6ZP^VHXZk*vMo$|^4O|qY	f-&y
x=yFc`LYIOJ!.a+4Se@/RGYv|	f9FT^6q2
r^N0e[O6p2v&fY.(RW f9Z_GwB?Ubzv-?ly{>X^|y8#QSY}|-xzhCWR':ll]_|2-ZkDs8o;n1yEdS1NW_4=?@? z{I+X,'9ph-}T\u>s/l..|1}x{'dnqqb}ve["PKs)j5/ObaS+u?d9Qu=%GQ%lsc3zo+8<xas8b=F^'{c;5V>g)j*w&K/D?N>rt?OPMnMs!![jM+Y,]@zwF3+VP<Gqh>y6$^o"|~%iCF/4c]vU*`
X0KoP7|M	9>q`?,)+'abn[
e~T4+74LXj>rcZXyPS\HTzwU~9GAv~2`6RR@lCY9:0S1[0ZJp/]!+BV>epX}@NMM O6FcwZn9^'g~baG[*,_?xng .ZZnGq[sw%>$ZvMI.ON?[)9s.ZQla?lo^SMw?'1s92	NNv
9`77/v6~1`W8ii	
/W\9tpI1mB/>e8*OsO|EMrIU5vm/v(zu3h}|7f.lC(Ul6PlAH77\CJ\}	^xc2l3nOB</x~xwbc!A|H0+0-kN;={TR8m`|uk+WbVyeGuOEp<GgH)@5=MfAY3%-Aol}Y#c
XJ,]+&zS0/,OeCAYx9~?f9_ymWzzu'`4g4ml!Dh@k
y_|Al?CiFkxJT.`M*'[ee'(J0+N%9o1s7R6tae=-h407>"m'TWO>/Lx:*GCQ_q>>kNv:'t|  @ IDATuI8	c?MN.>-`6~^w+1//\vxl ,J?'lmx1cL>lI-fBg}zFp'`@VJVYBV]?oOx7n1Zwt3>Sk>&T1V}7Gt\M	|RGBpgM98>~=g_G;]*XO??pmn}0#pC?k6w>;bA>/6sSOZ0,m!We)s7-Gx>#odtKi}F* M8ff
X,];r}P@c'w:Ran>gg*{(WS54WG@,]B)ej%Z18*J{4Zi_UxdDW>vjlk"#*WU>vb!v(Kor7ZZ0RlJu@?|[j"L&m,J,Dyk;'+bf6sIee(	Zj/jO1Lg33!)>0/yiw>|I"2JB\-mt9,xY8R.d[ZZardK
sHU0/a$c>G8#V"F&bMuRSCZ*_dik@i5>s[B%Ay1x=/ZDk7"\E	!Mxli?Z	'z
%|-xmUu%]:421I^a8rks]	QP?R`I9]S1L{`DM*m6Xfck4kXO|aK2cW	Frt7}+rkL ue0EU`]VutmORfS}!x%pmkZV
>3 -P1t:EY`SUxc{X4dieO*SrZYOT&yEJ @7!Q*f#TJ?ul-VH{vX,]a`vA\l	-!i^mp6D) >O?-kV.@s`a2A6Zr}f*/Fa*+,Zh m8B@K W+mLkr444$KEC5=n?CaGF/kQ?*1!t<x&MrJZ  nU>s-38-('ND}\u3XO$"4HHWOglFaKRibCh.0!uoKfXiq`==%!"HtFISWBf&4#r8PeDB#TAIY/D+*T'Xn*F9%[VkC)4
~6oTC`684A 	8X!'-$TT/1s1aGE}7E$rm<0wujd3qa\Uh$s mY6v+_o&-UU06RuMR6h+K_aIO/3-IZ3E9_aL:j6qg']NZQM~x=(3,,'CCTSa2Wz~43 OM8Sp9Mt1 `DF|q5e mn.a	
Tt=KotB!0kXRLs?4;?.R-(;	XO?KK_bH@$/cM.K,3l&>SmjZ`E|
2qy5mjGy?@c\8L\.jA/\M 22+eJsi=OSfbrhs/eoXWNshWbsa(PQ^ d%iAx2mQ4QPi0~?OV>yuVQd+gqe'TtJ#?FgtvGABZ=NkZss'Cjvm3ZK|s*-LPzi	scr5h	N_YM~R|h}R	@VU*`l-J>OU?8t 32;d>LvjN  RZJ_L\Taf^OAv*al;`$H=[}N Y[:Rdtxey>snxH0|FC@	J
RvX_0yq)r4iUa(UqB9fy1(~sezOAuVQT)<cm!?,0Nu~CBW	ZcV3YZeT^r06`9NsXVs-0/7$D)VyIFG.DL66A :_&_$[i\vfu`|R)HL06S , xHhv/CW=Ghb0LK3~^dQ)h%b<Z@!|.&8x&RL,1|g gn$lym-	C9 mJS>`,s^QPUK-tyOI#-eQxT%8:UC@%mg,Utb82fQM0b5h9+y\}|@3WtUZ'o)'>#eV ?>z7r "`YNn5FrV(;*K5r!mfSL	Y/l[9n%agi"Cm=T* /T,A~rkV
X06*V^z#yCV,(|(KAss0IfsY,k0j!&C*RY$$`FQ R&s{"HcY+xV
r&,Ra{ W3POv*-?hV9c:_
Cu6PINOYF)fX)<]SOif5S?jnsVUMuN'ilh3C70>V\-btRI:WH&3qXNt^yid6W6?9P=beYZl5w]ekV:`v`b@T<)F`yE&`W -Ji0aOUe9E]`7vPYfq
S0WhkT3~Ii\j0lw_(bGkBYrm`qZ@;jQpP`&`yj`Ze.&?7/+Pm:x26:mMPVKR? U}.6t.R2[Pu!5lk+g4^KeHF	gWxx*YEXT"	r_2^2vyNE{c3>JwB,_iu[s	 Ah[ML~EZ|LN p?Ux]Wf
XWf;oO
yu:zui'|!``8I]&q&0_%hB?n~PiDv&cgR=4@pQLU t4 3|T}US@UUEF	}5T_UQPQUqr@ g+1:
HvfaV'DyQ/tfg^_eE*n-j&{sTi2|gxuxnLrxmP.S~3I\s+J2hi$PTE8cV@Ysn\*'GYc m"Eq
Rk:*c*3b`i15XLQoTV`&.H&KFY@:CpK
2Qf.`!jO36`}$DX;{E0(}L/t6GKX9mmoi22tV&%d\yB6aWXZzM0zf^lkc	T	3hK,bZ]qB_tJs/KiWL7]
QmR+uoIoGe,p`F%f}/:@x;9SfTjJP:6iLK^_G?2sJ/l`*`DG#p"|te@
Mhr5uwOs25R6ST50g$"8kn|+cHkwf
XkegS.)W>;::|"D#}#,I	ute!k6]:6ZaJ4}U*U5)Mt!D2m|^d=J%\PSu1U@QSP=LKL|+Q@HTGKSY4Vf"Mbar!cBdTSV4a!hUNws
i`PShU^uYuq	55avfX\U_]S=mf1Y)ZPLZb6,W.UlFF$ue|$N=AY"KWY-A Zpa0Y:6 A)7WpD|>]JR>:t*!-_Bslqg4}rTub97pYPicx-M^0K{:B->gMf#Wu!|#(5qYHayOP`~wG*]R&=[H	/\F'+C+l;u,]'Kb<)o|	X9|ae(#-"ZOF\3,;Jt]!~s9ExN_yN&U[V)D8&r#e0tX$YZ)dY|k$yEuHjVU/X2kid[VHfI]k-^G&+Y;i"-G0p.c*f]:@j KNbUGR>skWZ&5+,?	22$k}qPZ.:CupVCJ]Vg#L]4w.-*Z5V.N@N,yvUcL74K`8um5R*qT|dYcY LFutr5dV<fr3AO]Q3@N%{*m*4;!Yr&fZsSWP\YvN;SshSO=vV]Kw]f2jNHejhAGr6&-tg'EEuKUU#7EPf;GPd(3`j(+k*SZ@RIg{(k[$9Z ri4I	B[[Mvm+-@_vV` w#YmiI&6DW*#7l	|4d?}Jy	{2/4.:%k8z"7IMxaZQgJx=a&$#3AcKErtHEhy:Cr_tgDz&ik3Bh>0_3-"_c68IWUF([*Uo_BLY%fTibK9A76},+i(-y4aU&Eg3ZEI"0k*+yc[v6VU`mQl:m*<:zu|UGXG:Z61<	'fe,0+ +>tX&DTZ%cpp3/onXuUp!<4te-Z7gsFv	pYW*Z`c~<v>8K]L4	G]M|Wy3PWLjBY43cQ#>eX'?: yRZBOY Mt%U>aU<H	cLR5f9 y^cmW]f9A~7V
Ji*!"u<L\r%xMWVafXK'P@m`YmF,^Z3w
+*z.J^E`Gdrgi/R2v2R~j_3%HUMQf_U|:1>YB9]
Y04@#8$^wjC|0/V-tem`/KyY`!_o$Fl! 61L_-Mpz'MYYHh|;\-\g3V4z3x85 _th]8teDF`'28Z=[nm(T1
n5]VC|;MrrZg	i	f^/7F6Z&XI>T)Z2]?'9rG9D=$q`&o5G*nZkq[VDf\S,;&|C	A0*Yl=Wc\0&@+VdO`BLq2k{pmb7pe:w}qUm:{36~"~QF=e)X466bxG6UYkN5uT}xO@jWm_|16 pON; |Um{m< |i>O<{D]LGOy9i+eApT\p@P!D \cy'uKYu){8'i)\-a ,j)cYHabm_cw2s_>h~h\0qA,lK[{m\^V1Wh3^Y*N8k{AAYV/W;3eU!q3S*hhT6P$d+:6?Q[lCu^ru 'z$Tn&d)_.GCKQs:Zoj`CxTq=:'L/-A!' H%PUU	?YfPSftCl@cb^^LwSF$
_z5i	f^kNHe)] Tw`LW+-x3yhl/$QNvD)_2Mh+*B[2'}KaZB<dh%2kf+mZ`6%05&+8\j!7meEIPK5z 1II:MzQZBmm;1BXe3vpe,wF,om_,]K*`
t~,edS>(gnM'_+9F. Y-#5qe 0cda,LDw R;9/9#Q2d%Yp3r99gQOzY(" %6CzzLOwuz_}{s50&;o#gr2:tH*3vm;$n/[jNV]kG>
>NSbp}n:QFL'<=X.SBKl).Te} `{Wn]pCcVy ONNV}{vI	^hiuXmPxY>dKGW\T-
b7TcH,=^B.GD.(,09cWTo9jGq=vaAY!/__o?, `@f.OR4ivU7s{:}x~Q
WZS9+ 3EH#G^..FG 6!6o'6mR'3sHC9
g2,qK0ZXod
j3,'d@zI(0(G}IEYPi$ 	b"?#!_~j3HFiiiNn!`bH 871fcs2 [I3=0H, H,:[y3c>k13Qhowha-i<#EQ5Xr"b2,N,l	Y_Yg)Hd;	 ia|(IZ/aZx+PPNXv#CC/zm,YmL^,3e6eCn&/U	U,`1fUY!u%xPB U) x(u ?-[Ib d^]~m|'2p$6x;cpNe'_ ;h" J"@j]q_`sw%PV7o+O_0pvW\e=io:wl6nK&mi+Vim4^} &vWH}rx-*C9v 0r6odsu`4CCH=ct' -X%s=5 *-rEd=9]vx*@_wv'xe8
/~d?^	au|0[`61fBpJCSO
Pnvc*pKF@n=[m{zNSv^dIp5\m('hW:M[5o4[ 		qnaKd+X#y7-	mP[0me/pcPD7(!,E+/wbzk|5i-pbDku=%Z_CC8@r[jMjm^_j-;	P,;3V,e[# 5vPdX`gz g''DBISm"21QK`S 4f;llo ijju#l3\{WV.Ik\E$v_j>?$D(`FE 10GPoLM3!mlz$9`6<rfwfY-~kZluZXm`z,d`Y;1`yxbwhR2=$$Dp?,XuvB;/<8~ZZ"G)A =#c%1k{_M6--u:kg/x^m~`2ycV@Y7u(9qY.Hp 9^TU^jL*W(P9`KZ;%'rBFg};G&L aO?`Rm$1_|0NyiL+.Q'{gYiRD_St6
X !C> %K;@J.Ni[h>mkbA8g
vMem\yu/3E/bkVy-*ouj3q, U^tI6 sKlG'hqSj9'.)b6o2Nc7?~6V5l>x=(wL @"dMwmVwCfYsGnv$Z_,:{W~?{* mKX8R'0,."IS gEh5!-4gTB6.{/[|M7kx5 ,
^`db	zFw m]YoHR;'"kyK$da$/=e~o>:w89KJE 6{E#z9y%}'6KNwrt^56JFl"
&B[xm a<<|r=#!&l)haNVYlK/8Rj&-fq8Y0N;2+:=~uo.pFlQa{Yq$Wa[C/`XfYoh  .Wr9"{w?SFuly9:6!//gZQY:8k^h9>}rxHfp|yY#' xyvXCX,(zlMZ+g<`v#0rBs@`&|*@c6_B7XY%sYh/8\sjjW%j<hUJp$I`
&|S9;>}\lZ}mG5CN:v b~`~i`8EM>s6w\{',~=_j{~Ga	xHUl;xp[o"h>v: [=~'Zz'|>.vz}[l k)ff#cwkv4BSK	9sg np`km2o+kMhi4LEKUd5ld>R}asV@vAv($]le(3N{uQvg;]9 '+~v<etRet4GAoY O4EMa`fSi
zi}IMwLCb_XVXvU\0"epf}lv)'b!
3`\	Xp)#HST/Wk_Nh4WE>]Cjx7\. cx>0fO+,zXYYvygZVv&XjJ{QVv"e_eg~	-gXNA4.#EkM5:bnwaFG>3'jgEDH]wX8.z9RSO	 $\9$-/}]~_}?YmE!2J#7k	dJ^{)UajuEecof~;xN@SI<*
s-4%#sd;/i`rB`:p;-ns%X[BV$)?8gh4)u,rvC5k=mc'xS?7={g0o,XI$S*_sJ7NJ`6W,O||$ 3pBJ2yPUUZZ*FUlY|u^^aMb}]I20ROI|[`+{y{,/bK.:;r:f[z`J~9s+Dg1 Ja|AUwl]9)a^$do^[NQ0:QyM7s?(pLX186$;-QQN;$rlr[[n]$V@O=}mN?`le[BLRz^zv>kuY>VZeso O?M=oc=AlP:u4[ $&0_I{,&o6f`6L,2T6)0Kcqj*\k?UY*!\lpJ%C52~sm] F^	WG[v%kl-)#%9&|>$6M6]n_6 csEDE'Debw\OD'f[O~Gw{._aQ
E`03}}k s}{[,23\[$	q_p<KdH#" 6?	RiR#$}b;vpI$bLV%K8-#FdJ&fKwR9g.o#B4(CjY"E|{4;]3U"K X2bm/6<^Ry5o5kzTr0m((D mQ0;t2n7gmf:u"$e6n;Av=YJYQ<+S&[jLlO}x2]l73 3,3g7~{gj0[V,P]0r2C;_ c)T\Q5XeV*ZSVW5WI_LXKc|0z`goM&V]d|u#a {;t%Le|&aqXPM21;zh;J J
.D]>W>~REe&e]tXJ9{l[dXWpR9rXht2 3}!	xP-oC(ll0'XziND4`X{w_;ISn={X?X'OrdO}Z4if- B?Z<xAvtZo69{r&Y:\~/xlmX%hU( H%fL(F[bjx4w{oXM(_y0y^q*@[q+9cZ"EZi}qzh ^}Va#YmY)<H(eVG Goi*z_
drIpG|+"o?d[->92d#iK{XGt<Ic"NBn$rd],9I!/LgA&2U0FS`8dm32FBO&X>XnCYY0Th+6Xr6Ksgmmtc=E:D^eX*{@NJvw:`6.,V-$	)tS.h	H9R)II0H1f;a+8o${q v!l$n =lYg0{Wx]qNZ+0+R2f	5F([e-&
+'H9HHo&LSOf;w7x6h?[q:O"J~`O[<ul 9
T;f3a6al7n=K[-QEr%sy ()L ~gY:K[+W 4}g G8Gp8K/	+8Cz!2!v-q+nhqn>![lhmvu;;l* ]'=>44j}S[4lC3\ N?eH ! 9f$'=J!%"[lw]r%&]9Y<.Xf'!#+Z<`Zt'{lmX%RjNGZZ
AvI&"dl]V=$}7-^ ~ i_!C\2J1U%{s~vcdZv"Rn=Vcv>=(,h(u!yAZ*0dG7	5@9j-gNGF?__0n~@\Us9 ,m8Y@OjX$R%hZN`!b|IIed8te"=v-"Vd16}L{lw%IYb
/_Z`=hTS6kFk]LB|LcHa=6c<KKG D.[tD	hI6692r  @ IDAT'RmZ(c~NtVIgfcgNj=J8Vfg?l<h\9G+}KY\I5`PjP#kjUETUvbyS,f h4R%E1q24$,}W<c]zei30~]w0^A_0Ni[ob&I+z.I%{)Vit%#IR'iJ<v`4Zl@XG$YgxhIP7_0w/g@/=QF9{0g&M(s mv~C0c5[DR%8;w[}4|CNF -Z@^pSEk'Za^zH;`%XE]fmc>G8XU$mE=z$?W{fzrKd>dCmO/ga[bwC;kPgD@W{HusY7`"z(c&
WeK#Gie~8*	^x/%E$I!>C1ock>Y \YL\xX{ak8)|?SGoeX:)96{g9mT
&"tg/n:0Zm(=yda8):O2d$K/1dSNDt+=cuk%SmuVH@zuk#&f	%H*U J:vv]ikH7	,6c_:WX}kHh6{+i;p9!##3@0X^>6u[ }-^_	k6UoHXWo/,ZMGZF7+,6i#zc~7}:w<x8,_z-:-_^>iU
Yu
5XTP,(?w4p~UHOYs/=Oq&uP5C=^=GOj:o,{7l9hdF8d"S 2bQ$UywUGHC	KW/GAGYC`(d) SNw3_o-&4Pi&Y2@JvJl-$3}U\+A,{:[l*\X{-D2h#mNCG8Dk`JRd4H{ m9{eF{/V_h.~@;w}GW*
y!5JnDz/<`V5\R[*J. ^T%G%FeKMfY?Xg?^SFZua f8"z'I'bNB#t/0{T#1/1 ~x[d]0+=	;7Yq_	|
]t8suc^{-g8IdEqhg:i%;v8-d
~b&-A1OFP~tl!1;t`W_u54Yx#Jg1Vu
_Q#nn56yZsV[K&yX6%V~+H`Q!L]k&^Qm,	~@4<t	fumMI[J.u [\i/cv?XX4tx n<c=`;g<`@5@y6dMh{,js5N55a0h5[b	N_ztR2(9GzM&@v. K-=N'? M;IeUmr,Tn:?!F%[)a@Fk0{3cr #5kngcH_F
=mK"]8*PZ%OI+*
8eE NsGTs`ka s/:pV[n]r8)bXU]IUP,fpJZV^]bR l'p@l>+lZnTc0iCZbs];o_[wcv4
,V ZYpX$;[vTeNkU63$X%miI~6~#.vhM5y]v.I"	N9T7nX$n 'O>.!i98[3s{fJ{OnFxVh1 x4bNUlN:3V5saN6L`!lbkl{ i2
tZ-s\XJOr[I_(k rDkg<k{~=2Tl-/~'in,l;yZ^v_^JSF{i
cKNl5s6ul;l_Kms.w>dORb7'MS84"-->]}kXYd>.u7/f<x,pZf}Y@M
5&	VS\jd5UTU}(3d}[V5kNE0RD
GUxfJ"c)A(0Db	E1w!{Hp!.X1] ;(>!4pp*g?55r L(0@+QJ%tVD+`2
8VRR\v G@t4@MY8j*IEm#I`l]4Z4IXS{ J"P">:0j.L;X+{JA N}J4E!pvLNT5}ikfnQKlJL%\,uIt!4oS'qJb\d=<Hd: ;"Nyn(y~I'Yl{DN$K/d,@5kbGj1 fqCs]j!qF=Lst%$p2	=n1l";[JS8%1cH9$q:<11q{/$qFqQnw>1rKm:{=rTzf-]8b,oZd{ysKs
1eWKx{d{{a|]>\=H<kSg~kCn f>\4f_{-^zVAS|WgUKg[
2~>K`dKkjN/(K`L!Pi/-vu<]8Jt,3yFB%*(i}{,Y`,f/hD
	A8Syehf_df>VlUj45&2ZZSEXg#%z&C0h#p#`srJVU9' 4P4}Uw	`c	^C1})|Ub	hx+h4Y`,r`zV:O% Vl#pO1OXUraIx5/ =4 ^Krrk$CU$l]{	gTZ+UZYYImb28{l]t FaUw2280rc{P~0~C,!AMjPndc#Y^{I1u: ^og, `fw
fmZ}hYEfz1@<go0bM4 2,]vI 0g<[g#R/@[qZN9aI|Uov	!FrVVzO:n0ajXlfs 0o^ PLxw9]Yf!t])qOl!bj6*vodmX|x|YPc}vwDyq-@;lyI!)qVPv[x=k]s\7-]aU-{mko fs f3Ym@oe 7`.F@()ygvcZ9k>F>/k],.}2Kp$KF+-A,qrf?z17oXYo0[nmm>}}f-Yg<`v6W0<)4Ws1fJRi*dbVh('8298J!-=b
;Ye%Y@QE1V4-+<{
Pku`*20s1G)%TaqQ4UlX*N:yq+(/2Hb$P, AN6r(KWh-Z	1(7;,5QuT/(N>8%0	!KCPXU}<+{XS
UK@n{.< X{O-{fyO(^_n<SZsGefS&s*`>fmq^b*rE2Elbq+c" n/8Jk{afW]	(-Is|$<9lwHaz;	`aL.KqE>;S;D~}BB8:DHJz| Iy1by;h|:,W1{eF!=N^!C@+\3>[?i5>^uOq@67NcghX$VzI{o"wvUZroFkY7Fzf-\ic7]3r3_>j7lnr;,Q2MsrA%K=PoNk_^z5gkgXzdLlu ,dEAGvm3NnpiayFp?24w1fYg}=:`[jN67`T)	!.[)T UB	v3xXxO6aO=)-h?`eXeP,Ab4sFNX8B.D8NT;qn\Y0Km\Q	<SJ
pS3\m#p0
f r9_+W9= 0'Ucu m\}'L `*`0 f*[r3N+lT+puXYLNJ$*/vHBYQ]*j*Q{iTT[Z z}=$Umb9RAU0L_qGq+l
Zb0@R*\6~U2qb-` J9N}#)}i}otO |qZo0+;gg9jl>PbJ|{A=k7<`G_w3VL1
y%*l?BCTrJC.'YV0P>	O@|m,[!XV9}W69l,zf3<Y$ Kw1.$q[~G|hfK:=sVv]yMpjf?M6/>Xr2{m5I.Bd?N4=o+O>%^={9mZCE~f3l2X1)o-s[o E}pK	6:@n$+c4X)cHFnE{Q]g;,<{%H>a;vmdekI6}H~YZl'v&R]4|mH&~)c{vvX-;> SvQ{D3>t]&jYIsbzheIc=$7T,Up#o++Yu-AfJ}omi	cvwzO\g~[xokoj~L"\>)2}w_Lw$[$3tu8P9H % C&s@*wS V>;I?5:F>S!q_
OuJpV5Y@U	s ,`K)^ K	 []s3ZF"p8 `-g(BU=V<GmNuP-NjhS]!G"p+T{\sTz\~V na
a%&V*XL:{4}.z,1v~WW?Rl;8TLkh/yuUCZY_Rw`foW=70gRT<_LfQn~Qr4~.CjaIRuV[|:+m;SSRRY,Y94~kQ-JgDTLCU+2A}fuIf1}1huHSkX[o]4;fqHqw=I/$"/gv	[Q,1 +VU`6%sEU4Y^#f IfF1-R27	#Iaou ck X(*eWM5%wXV:udS"I3Km6!b|rmvac8clkV%i`=t0D',k6d-\)3^CnV,rB
iqcpj:4y	Xl='t4glmzHKtDfN8'nW:'`RL- _zgt6<x-KyQ0i54UU;<} ff&Kb.V9q$C@C@bX!b2S8,[Kq`9pkl9O8']H8Jasr}Qh)\(CULZ] @Z%V@MhaW@E]Nu^U6{9Q{B#{'gpB+V]f]_
w'[	cb/f0rWs}F[Gl!MU1d+mWC}%{iS_^2$dGn_!Y:J8rete;
xI\~4?!ebz7{MzK+V:.:KhxJ\z?qA+IYz*:@m", faxRc+~Vy/9`:a[HgK>8 ,%jSg\\$\JysK9_^ Lr5?U	E|VSQ2NLXNe35hK(<E*}Ioej@T(1H"&^#Eo9TM;WRDbXi{D-( ONQ\?

`FY"K MlVWR(_Ke-sa3&'K7j]"~M,ah'9f_d6$<T`_f ygaa(9x9#ti^+Vh?N[)y9~9c:v1pqdbq91Xy$	)4cJ1WU Jmx!tt=/F:aPLI	mH]Ke.U'0*wUW]p@1t#JxA-+o]. ;yWhN`v/8<aj-JS%_ 'Oc+^*yCU 6i:wh>]8Nh 1;7lA%XB4*a\;[&[{e?Me>,Ro;}}Cij f e f:*$o pUJ1_{AgOKK$1b	EBja %-Dc?{w[FC:aw1Hl#fe"ICJa.{BcLB\NO@mq-I/F2=ip*EpLB'V@3x$TrNZ4?zj[7*xHc,ZHw\>Ww%;%jcbj8-D]r/b^!]Cf)g1>dD9p(%GvbW6** \i%{*)(EHb/0KGf<x,pZf}Y@>M6>3}`Xzs0?Ia\b2W%%Q Vsmrn
H#FO<0I/c.eZj Xx*r`PN|'
F9*!C4I,< w XLK#Kpt
k9 } PrR1h + Xm
Ko,S2_u   {W1
%u6^Qg dmxtX!4^BM~:cW]ueS?Faoj*9 h,M&S3uwV[e?:L7iy ZieuMuVKx^~v<Sd/+r1?nf50|AHI0
=%x)P3
k9K ,G4jk4 5P"qLcThmDKQL5fbh2>_}$"Ei@=$ s\S~yDppx.(uX&VnQ(b
T4,Us {XshR,u$cj"VWYbpZFIEX6sxW8yIJ$X	L8'V -|0<6RblTM6o 4&[i3K^aHD-r ZEEO`)=zR\GFWbNAw[
MS b4pcxT?lYg0{LJ?UXsT7ON^> V&
@g9&nG%O`f
asP<aM!3qW-)x~UR#pplYT7]FMH5r|NbU+]y{8)8|c)1lu#GuI(]
P?
va[l(vq)))4RI+X'b8J :^66V{}dN9Jr(M/]>1s
`-:\X' r..iZ.S=(s|	\9rZ*`z0[~R]'U<lGO"<S}s;<
_	MT@8tU_h`3=hi`V}#X4-	qE-b#eSN4kB"cckf
 >!]*[aF#M9 "oP4d,6OWh&U]`a9pE!cl"Y-@kluml-WuTGeSmz<y)Y q9U_x"[`= hZ,0PT_tP+3$rn`pRUs:Tk
^WShmz.j,"4U}_nB|l,4{}|$`!qf*1Vz,Y8}` /MsY752djS1a++I4YxflRa%'Izr$\!$o];mf8)n{xHTrqNp/]
eSZzUZ 8k7vweok*:(K%@''  ,kD
01:N":)sVm\WZS6%[z-
T&M)Xhm<-K9+@X5#){#`$vBQtKJ*6RZ]2Fh7	[M[e6#Lu-P:bEYLO,@c@ZFT`//Zhwt;IX{:?wcCTFaBn9C oon:YVzi`6(21i1S >n| d_+.J@%TO4I%sYAVE@asIe{4Jo1& PlIHgV`\*IK*)bGo(`T\(?l(A[_%QRu+m`Sw1UE"BAv8W@Hl*SuQ~GRZ4<e,g!KtB[! ,ZHA<_eUPW\9hy`'- h">0,5L4v^FZ6?gw hc+1_5OQ.V{)+X0Z:)-s(lNH&~ =:kg~0,Xyi\gC;7|`L8+8`&_ze;gdd5O>N8x`)|Q\B$UZr`Xm;pr,G'M6Y>}sRtzu,1\^?k|ZjcBDCdI688cUoCv74v._O=Tk8|_D"'|&O
e#^{[\zcb9r_6)[3)'W.Kh;_|Ug]?3+[dg/&Ov%#FXZV3s]ZL!\\r23,	GXeCEtV4W^jbfUA
@X?jSU?vBgV7wC5kY}1fac=W=`ZEUCs! iQ?	HC+8FBJT5+SUL-9VsX+q}"tnU
P*Z|@jW:cTJ\_j|"~8Z.>Q2wEH@%fpHIV%LN6f0M^TbV+eSw=Hv71TBz!l<-c1='l &<bK0H#'|8Fwv`-, )"c	eX~,Z2*8#SYb(Px	L$EWssRp[O:H?h	c d+3:u=<`,Yj=X{ke9X4u-cB1c#ukkwO_XG3Dn|rDp~y1SSeR6q]W&8Dy92kziI3:a_p}1I,P[Nmns@mpV6n;lS~$b?`=bKQ \H'=WL_a =a$ul)pQ!B-UB/hK!>l~h"}{nGbP)WXN0D.o)V!v
^5}Ku7W1UWQ|A(+X|'g^o?e}{Cvwe:XV#<`z6fU!rc2i(~jB"	Ay.9TX;]V|#1Ea%(
UIAsOBc-T)9#a
C(of9-%\uhbKE ##J%X #aVG7A$EWYIcg57Q[47pus6UJ1TD~KUR@[qOdCxYcmyCL`BPM$V [1GLlnEFHWre	8jG]]mdK (%F%95cUsI@yf[JBiCl@7S.n 0ayl5Yg0{ vW890`!3{TA}gF~faxhB
vUN{v	5i 5([xeLL\|an5+W"za9jg|m7|wvjj[uKLO;i]q,Pj_&NemV^]VV\k{h#ISJ;Zn^kVmvwRB$FPiDtK?cF54Z^s ^:8&ua&% .]XYl6 VNd38[4x?[Zmq&6l*KCb)S/:2Iy ^z.7=j%m-`>c$;!/]^GR4J{#sjpbZ	
du@^C~f{C8{Un}*Z{]~Z?VBy%:7~=w{~~:gVCyls;?Uo-U]>gT$BW%j
,"#[4 lKdR,S
g80YsIV%pRu8Gk9V.u%:<";OJw@p$I@UR~MIX@Uoj^w9h1C>9[FsR&eiV*WaS2A#VRI=X,Q|ff-T~Lr,p\n3-7"-<d' -<iR?I
s"wVJ--9Z:+"+./0"|>@fs |cH`XKK!z!}gxs	R|-x/u=H:kg~<`g;ntn~Y59?1K8+NxRj-u dR>}|e2E;k-Y>uhO{N];{|`[wm[Zv-Xn-<b#1EpM#x&whO/ZgKKb]X1$u?Zl  n_Mo//-95m0H5>s,R^I P'of^x5d;V/i3s/C-A
cOUm8%E:5y8U#4:6 }8-w\`{=x0m@I"$dUv wmuZ8vQ8q6d`[d1'nzku?4pvLvgk0^nT `+4C6>M{]w; ]bef#~6l.S,r=\\7s`nf  @ IDATm3VyCY}_ >w/Cp~d;R\{xX4 {`} C8`)Hc^ >heJ.,~kx{`* 6~nsu)v-DL<oUu=* a	 5:O9@C.nV.uoxV8]k`:`?cwO]#g~mD>#;^3[jcww ]vTQZs%U;Uy}Hk%_dOLLU_-""C!yqd'=C3T)Fk >-SZdU-~zUt\9A2
E}mJc%,UB Ek0#(|"I	d9%C @5.>l+G 3YM]xABZb
9''9,C$uz\_uTXMMMv4YPL0JX:/A&	RT,0k%DMBKiU<>]{_y	qeQP%`P#xnJ;7:P0:.g9l,@X;6-m9.r NTDd +?qB+S"pxfW Z]WL%$lR,`.x]&%TXvV.^XH06 P)<a I0"a?Fo9stQDb'	t'{Q;tE_w&^}@ ?rtx\uW{ZJrC*axU,YhYg[&v7Lk?0kn&|S>zc^svLl$z7.ae65S<fg{fv#WXgb}[vvX-n>.nmZ3^Dk=|Co`/qys/>[`K:vE'YZ82^dlYg\dcgF?k}ZUsh;?ZFqgX{14n8>'Ck'xKu6Ba\swy0Vm^x	~ew}vO[hpV[jiAi@p (xH'77v$$!	 -v?j}0sw8RvUg=Y6#YM,T4V$2eu[8ek7l!s|uF>h=[JU9I4~VA}{g-8vmv/iOq+U:	_i$?:"zd%%E{o{cs}e|U]?\ Y|[ur:to7	U_B@96JmES: G,+?G*T@UKb\ TXf!rE!v"I,lY*+cS',Fdrht  k,f^z$p(GP@<3~@ 6pNvme@qh{K=>`yzb63w' kw$>B Rp0NH?45-$$dldz&:1$o|ppPRcswz+JZt`	$iS~
q5yIVRE+CQEd' mWII[LUY%RSJ\*M`k$EbIF1PXK #p`q$'r&]#_:l|ZB pCfpG}0p/H7gGc?RqOMJ&/`) Rsu2L91T(;4G )!h"k*E\bte
!>k1+'6.pEFGN9a/|T.&0WkIA4a]VUwHBEJeMGO
d}H3R
8@ A+ o"pqrJ\Z[[.oxk[Nx?^g|j]Nju3fI2e;~me$ J 	(npc3;y;{6 ud_vC,smq#1%#f-oO1VDic7X--:|Yv@bfk?x>kXH?l} %YsG LgvC7YBXvl:yo17W:yjMl%e6>[{<{9X;+dr}7v:Ms5,'/O=i/7kc=9c7}k	kQwG!rz?5VYA,`a90*N9m7Jkg]xj;r/]aU`.?5AXPG3L+VZ
vg+'wK%>d {I(,uN+]@1Hz0U?-Xh*p=Y.NUttWW=bR~4x+[}et*JA+p%	H p
DZy dxK2C f xR,Y=ae+HP-Ve_ c$s@C.(*iA1$zqxq}`Yj!!B@'NN),r!B`~ixfr:/w>r
+I2+tE 24#z5)TS|x$@(dx`@.?hin~7`yk .^yRE_(YWVV;IU %VsQE}gYn}5P<U/W Yt7m6BS[	3aI>y9<\}YZl`=r i%.GSqDd;-[mCkU\-u<]Ah)V"X>.ovm[N](.2Z
U,.ZD5QZ*c'	XKud_,Cu{,wh|OH")0d+C8rO3hY 4sM Ft:p.U!u7mDf4IyVi\H@7VRJx1d`#N+	)3]^u	7BWrH8=i}@det,|NFA{LLArbDGDV3L"Rr: WK057hJ7/0{6XRzOUg8@/m5Q f=$
i2,Ux.JXxG8M	WeK]l	Y$T#1;f#Z1oMKUe*?hUi
`\zC"y5mG]==S[Vom%[T6>J	hyrMVA9[m06{Ow Ge[@Zx5*<C)15b;dAN`D{P9&e$FhR8p^~U^]r1X'x*'TkVkcVQv\l 6cX Vn}k^[bmW{n0:7L}Y]O?ny11}p5?{"`VDqV8[ "^p1PVH1f3Wz8?r9EO`0}t<yCbn:Saf0aeSK,VR#g1C1fd
*^<.oe@ *i0wy<0jC?ar4@|,T@z1"Qbade AH,]c([suGPrea0yb-D7DQu%uv>6+~~u=RJ*S lu6vkw_1(E{J{eG&x  JH@dcXBBQ}\Xyc0wbi)<=SUk;i??:k[K?X2Rwo</YQx\.gqereIo- tWD1.2*Y!!$<6:CRk=
03fpv]|1QA~/_k+oaj#Y|<fnT$rT_W`sCO[8?Mshd0q-b`w>hws.gmmNNE	Ps6w\}zmUhd-A_Nsb {{M{-_<SU%@B/EM*2DDd!O+]9r/Zn} ok[$dxmfv-iHkMRZuHU[Rls l~?8i6BWEZ@LEeK oz@W:W6mtyJ U:3Mbd;?/0{DfzHd_{]}}la+r_Rrs;\{ ,E-mv24 !< : aMKW6Uj#efT^j0g^RRcV&p{S[*f7
kc`e]~`7xUJam6fLi=K>s~.^ou[RlK6 }<T>{~'`K[tf{2TAOv XAvQ}pC}l/,'{k@ BUV
%6qx{qKYah`Bm1y.<>VrU`Kwn	e pN6={v `>c.U C)~A+*}) D_*+AF{+^ab=)ZH}])?|*f-^~/. c7 m;%\VVK^Y,[ym?p
2n]_T*l}yKI9O]3oK\0X9Gh, apwZCT Au
v5iR!V,&,Nf0S/ m,F$0 fHJcz)6jhD/0F,Q^):4fC38)$=4w"~FMml5k,K_fLI?d6n$r&9$biS@U?z_ ~7*aF<J<qIOGPs=:}g;~9{2]D'wZ})-T7) &MOn|%2GX6DP(@64(Y(= t)5>i
ga_}i5w2?N-`n,mQi*&.+!I@j9r(\M7L_[T]8)slSlcWQz*
'i~=+,K!/'dmnfCZfgQ#XS#G3K,l=XM
P9u}MrQ%4e-p_g:(rmWuDd" Git53 loZ[{S1>T#0m.ka0Z-k:ukXq^8&OO?oi	5F%^AmG+ckQT ja6voKK8CVO(?V,Xqb~V/>Og_:[*oxk[Vx?fZ0M^WpX@l.a,}CH=k`{xhe `[&.E Le	F<vmJn;rmSm`ugrZ^0)	.`=};Sk0yy{f2~?n:l`p*	Wbm]wV,X&	U0FSm$)l}gJcw;|/Y1v&bLh6Keq_#~44U'$10(C- J08>Ch3t{yQOeA`3[6l\XkCe 8hd9/sf{:Q#&9GG-e	+4IE~*vhOPe].>#2i0AZL\40EBe+B+~wUrw,@2k?]~Z@GS|,\1<TEg;OHb{mJ8fFcCM  G(Af^=FmKK8 f[Bi(%Sv5kbGbk`J`2y#`7y_:8&Q`-_>V~m?~/76hn7pK~]B3cc o\q^emf>0[obJ664c1{L={"-s7a2q<vmk6blQLJoO>c
R[omkpat=a:}9sl%07/_[z")Qg *e W)' aDz- \ ;@/JM@[qp8^ HG}P XCsYQ2KIH+U ui-+[!C.2r.^]L.g_3bQQ Z/`u$%}@
biN?H]{^{5kqu i
NS(=m_-gn*%TMy:u(/nK>@Lw?Copg3#sB4$upfu 8+@2sRS2wiG`u9<4~Kh$7,Yj:t;TJ$+A3.V'"Q8YkQraNf yq'uT8-{)%An ]*$88)*;
2(^xUf[^^`Ob5 8e|nV5_5eW_;}h`i,%:'3` mx@>o{V)R0Xad]>fuK1Ul\;i6]2,|_}uZmx{yjG 
b/vA8iMNHnO5BYV,j4mR] sy:XZR:>S(_}*g kX^7Z}E.c?Me UuVb_mQjr 7lsB.b|I!v=mF:t {}mkK6~X1c*)j[' qZ6?(qm'/}C.F0'SunoOwL[nm.y;cJUy	lFH?BzU^^~w%rgthwtHqd3{<@ i9P&U8tV/]
k]"o{o&MhJ8 [@nW$	.-;liuF)mo|%lvn+{c"UIb]`00mK.=g'qaBZSHWl a7jKj&f0fZcbNiSkQ+.fU	{7/cC!4IG;,[<.~d@i3_n]8y9ItYk7 G}@4buuY35))fh)\23~ecVt,HR2JZ|8Op`Mj)3U%R0?e3N=wnadL$J\13~8pt'Q`3x1W_c0y') &s>Q01
1Y3 u6;~Bb Pl+;*W"hd)1${-By{-M:PZtZXBf6o1Nb)gv=?Fw5y+SSX'Lzu7(QSO}vX%GvAS,L@*
U)UTp,'}LtWv3Msg~"br}bys"0j0!
mA;X?b9@4&)%GFFF}v$Bu /)	/~qW:WG;xKoxkUM{Wn6z]}O $J%,/$1+6|X8-$Vj0z}f]Tx3:I|2r3-@xx\RO]@}paN?m5VM9fYr-0&?c2Ve o][rQV".MDK:YUPc(EHa	%%ZaH	#EHY^-/a	{Z  x7tm FPR9q8FXy !I&]])}`*o=r*FGc+is_94feI4VfRJjeV	)%x9y[)U%X	 q${,i*fEaY$$WHtFzoV"PW_GDK|?BL=]v+,2KucckPvb&E~];9r6~$_v;*o ivI{gVdmWA~dY6-0Ro0^1;f}$ [gSC(<;D2X5?.sjZ; A#}[!k|xq9x7^Jz5G{A,F\g (WR0Odwr>M<6RK={>3
%M*\@C$1BwkB]~sE@C$y
0a\IfV$s_?auIr7y>|' bvl/:BU Q _~-YWJt	x8BWZ g+gigKCzj\
f^TARhOIX;9y\ vQ|sXM&Ah,+d%K2li6O<c	5a2<2MM.1{	YZ {a|gMpFG JH"@>~xm7+VD*9Sz ?k6jzDe-@*DIf\#FIW E=	(o^o6[;wLeHO[u-HUt6K8)1YL]!kIl!YE<sV).Zkg??@SQ:/b./5{A$;@b.9dN?dB4&=_|-<kEZ}7{Kpl0]Iz8ALWf[{k(-!u:K01\Y\ $
T!{?KQA' l^ J/3==b*  P
 
$D1pV
#'-+//>g[60fq'Qes0| [2d@KVz}2aAdD
CIdP	E3DE`Vyaa`Gg9a=yEdTH]`!tfD%I\/?B03I(+Cym\'HOF6KXGt `1:	#C#]  , 0Sr.?[%:N>98o.EaE!KC$ ^ho:.Pz\@{k/221Ja ^+ mqOUo{1/.P|w\]V^u'):39ER_Ek=!-rebra~qQvAtc1k3 ZZ]vH;b}rk&P\Yo^:x>c+S(xQ;7p5<8Vg~n5q~B+ L	_xv|a F}>	Ykvl>C2H9^)e(9L'<9%&&!;2!3[;0]|!Am?.cc\