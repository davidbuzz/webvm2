/*
   This program is free software: you can redistribute it and/or modify
   it under the terms of the GNU General Public License as published by
   the Free Software Foundation, either version 3 of the License, or
   (at your option) any later version.

   This program is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU General Public License for more details.

   You should have received a copy of the GNU General Public License
   along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */

#include "AP_WindVane_config.h"

#if AP_WINDVANE_ENABLED

#include "AP_WindVane.h"

#include "AP_WindVane_Home.h"
#include "AP_WindVane_Analog.h"
#include "AP_WindVane_ModernDevice.h"
#include "AP_WindVane_Airspeed.h"
#include "AP_WindVane_RPM.h"
#include "AP_WindVane_SITL.h"
#include "AP_WindVane_NMEA.h"

#include <GCS_MAVLink/GCS.h>
#include <AP_AHRS/AP_AHRS.h>
#include <AP_HAL/AP_HAL.h>
#include <AP_Logger/AP_Logger.h>
#include <AP_SerialManager/AP_SerialManager.h>

extern const AP_HAL::HAL& hal;

const AP_Param::GroupInfo AP_WindVane::var_info[] = {

    // @Param: TYPE
    // @DisplayName: Wind Vane Type
    // @Description: Wind Vane type
    // @Values: 0:None,1:Heading when armed,2:RC input offset heading when armed,3:Analog,4:NMEA,10:SITL true,11:SITL apparent
    // @User: Standard
    // @RebootRequired: True
    AP_GROUPINFO_FLAGS("TYPE", 1, AP_WindVane, _direction_type, 0, AP_PARAM_FLAG_ENABLE),

    // 2 was RC_IN_NO

    // @Param: DIR_PIN
    // @DisplayName: Wind vane analog voltage pin for direction
    // @Description: Analog input pin to read as wind vane direction
    // @Values: 11:Pixracer,13:Pixhawk ADC4,14:Pixhawk ADC3,15:Pixhawk ADC6/Pixhawk2 ADC,50:AUX1,51:AUX2,52:AUX3,53:AUX4,54:AUX5,55:AUX6,103:Pixhawk SBUS
    // @User: Standard
    AP_GROUPINFO("DIR_PIN", 3, AP_WindVane, _dir_analog_pin, WINDVANE_DEFAULT_PIN),

    // @Param: DIR_V_MIN
    // @DisplayName: Wind vane voltage minimum
    // @Description: Minimum voltage supplied by analog wind vane. When using pin 103, the maximum value of the parameter is 3.3V.
    // @Units: V
    // @Increment: 0.01
    // @Range: 0 5.0
    // @User: Standard
    AP_GROUPINFO("DIR_V_MIN", 4, AP_WindVane, _dir_analog_volt_min, 0.0f),

    // @Param: DIR_V_MAX
    // @DisplayName: Wind vane voltage maximum
    // @Description: Maximum voltage supplied by analog wind vane. When using pin 103, the maximum value of the parameter is 3.3V.
    // @Units: V
    // @Increment: 0.01
    // @Range: 0 5.0
    // @User: Standard
    AP_GROUPINFO("DIR_V_MAX", 5, AP_WindVane, _dir_analog_volt_max, 3.3f),

    // @Param: DIR_OFS
    // @DisplayName: Wind vane headwind offset
    // @Description: Angle offset when analog windvane is indicating a headwind, ie 0 degress relative to vehicle
    // @Units: deg
    // @Increment: 1
    // @Range: 0 360
    // @User: Standard
    AP_GROUPINFO("DIR_OFS", 6, AP_WindVane, _dir_analog_bearing_offset, 0.0f),

    // @Param: DIR_FILT
    // @DisplayName: apparent Wind vane direction low pass filter frequency
    // @Description: apparent Wind vane direction low pass filter frequency, a value of -1 disables filter
    // @Units: Hz
    // @User: Standard
    AP_GROUPINFO("DIR_FILT", 7, AP_WindVane, _dir_filt_hz, 0.5f),

    // @Param: CAL
    // @DisplayName: Wind vane calibration start
    // @Description: Start wind vane calibration by setting this to 1 or 2
    // @Values: 0:None, 1:Calibrate direction, 2:Calibrate speed
    // @User: Standard
    AP_GROUPINFO("CAL", 8, AP_WindVane, _calibration, 0),

    // @Param: DIR_DZ
    // @DisplayName: Wind vane deadzone when using analog sensor
    // @Description: Wind vane deadzone when using analog sensor
    // @Units: deg
    // @Increment: 1
    // @Range: 0 360
    // @User: Standard
    AP_GROUPINFO("DIR_DZ", 9, AP_WindVane, _dir_analog_deadzone, 0),

    // @Param: SPEED_MIN
    // @DisplayName: Wind vane cut off wind speed
    // @Description: Wind vane direction will be ignored when apparent wind speeds are below this value (if wind speed sensor is present).  If the apparent wind is consistently below this value the vane will not work
    // @Units: m/s
    // @Increment: 0.1
    // @Range: 0 5
    // @User: Standard
    AP_GROUPINFO("SPEED_MIN", 10, AP_WindVane, _dir_speed_cutoff, 0),

    // @Param: SPEED_TYPE
    // @DisplayName: Wind speed sensor Type
    // @Description: Wind speed sensor type
    // @Values: 0:None,1:Airspeed library,2:Modern Devices Wind Sensor,3:RPM library,4:NMEA,10:SITL true,11:SITL apparent
    // @User: Standard
    // @RebootRequired: True
    AP_GROUPINFO("SPEED_TYPE", 11, AP_WindVane, _speed_sensor_type,  0),

    // @Param: SPEED_PIN
    // @DisplayName: Wind vane speed sensor analog pin
    // @Description: Wind speed analog speed input pin for Modern Devices Wind Sensor rev. p
    // @Values: 11:Pixracer,13:Pixhawk ADC4,14:Pixhawk ADC3,15:Pixhawk ADC6/Pixhawk2 ADC,50:AUX1,51:AUX2,52:AUX3,53:AUX4,54:AUX5,55:AUX6,103:Pixhawk SBUS
    // @User: Standard
    AP_GROUPINFO("SPEED_PIN", 12, AP_WindVane, _speed_sensor_speed_pin,  WINDSPEED_DEFAULT_SPEED_PIN),

    // @Param: TEMP_PIN
    // @DisplayName: Wind vane speed sensor analog temp pin
    // @Description: Wind speed sensor analog temp input pin for Modern Devices Wind Sensor rev. p, set to -1 to diasble temp readings
    // @Values: 11:Pixracer,13:Pixhawk ADC4,14:Pixhawk ADC3,15:Pixhawk ADC6/Pixhawk2 ADC,50:AUX1,51:AUX2,52:AUX3,53:AUX4,54:AUX5,55:AUX6,103:Pixhawk SBUS
    // @User: Standard
    AP_GROUPINFO("TEMP_PIN", 13, AP_WindVane, _speed_sensor_temp_pin,  WINDSPEED_DEFAULT_TEMP_PIN),

    // @Param: SPEED_OFS
    // @DisplayName: Wind speed sensor analog voltage offset
    // @Description: Wind sensor analog voltage offset at zero wind speed
    // @Units: V
    // @Increment: 0.01
    // @Range: 0 3.3
    // @User: Standard
    AP_GROUPINFO("SPEED_OFS", 14, AP_WindVane, _speed_sensor_voltage_offset, WINDSPEED_DEFAULT_VOLT_OFFSET),

    // @Param: SPEED_FILT
    // @DisplayName: apparent wind speed low pass filter frequency
    // @Description: apparent Wind speed low pass filter frequency, a value of -1 disables filter
    // @Units: Hz
    // @User: Standard
    AP_GROUPINFO("SPEED_FILT", 15, AP_WindVane, _speed_filt_hz, 0.5f),

    // @Param: TRUE_FILT
    // @DisplayName: True speed and direction low pass filter frequency
    // @Description: True speed and direction low pass filter frequency, a value of -1 disables filter
    // @Units: Hz
    // @User: Standard
    AP_GROUPINFO("TRUE_FILT", 16, AP_WindVane, _true_filt_hz, 0.05f),

    AP_GROUPEND
};

// constructor
AP_WindVane::AP_WindVane()
{
    AP_Param::setup_object_defaults(this, var_info);
#if CONFIG_HAL_BOARD == HAL_BOARD_SITL
    if (_singleton) {
        AP_HAL::panic("Too many Wind Vane sensors");
    }
#endif
    _singleton = this;
}

/*
 * Get the AP_WindVane singleton
 */
AP_WindVane *AP_WindVane::get_singleton()
{
    return _singleton;
}

// return true if wind vane is enabled
bool AP_WindVane::enabled() const
{
    return _direction_type != WINDVANE_NONE;
}

// return true if wind speed is enabled
bool AP_WindVane::wind_speed_enabled() const
{
    return (_speed_sensor_type != WINDSPEED_NONE);
}

// Initialize the Wind Vane object and prepare it for use
void AP_WindVane::init(const AP_SerialManager& serial_manager)
{
    // don't construct twice
    if (_direction_driver != nullptr || _speed_driver != nullptr ) {
        return;
    }

    // wind direction
    switch (_direction_type) {
        case WindVaneType::WINDVANE_NONE:
            // WindVane disabled
            return;
#if AP_WINDVANE_HOME_ENABLED
        case WindVaneType::WINDVANE_HOME_HEADING:
        case WindVaneType::WINDVANE_PWM_PIN:
            _direction_driver = NEW_NOTHROW AP_WindVane_Home(*this);
            break;
#endif
#if AP_WINDVANE_ANALOG_ENABLED
        case WindVaneType::WINDVANE_ANALOG_PIN:
            _direction_driver = NEW_NOTHROW AP_WindVane_Analog(*this);
            break;
#endif
#if AP_WINDVANE_SIM_ENABLED
        case WindVaneType::WINDVANE_SITL_TRUE:
        case WindVaneType::WINDVANE_SITL_APPARENT:
            _direction_driver = NEW_NOTHROW AP_WindVane_SITL(*this);
            break;
#endif
#if AP_WINDVANE_NMEA_ENABLED
        case WindVaneType::WINDVANE_NMEA:
            _direction_driver = NEW_NOTHROW AP_WindVane_NMEA(*this);
            _direction_driver->init(serial_manager);
            break;
#endif
    }

    // wind speed
    switch (_speed_sensor_type) {
        case Speed_type::WINDSPEED_NONE:
            break;
#if AP_WINDVANE_AIRSPEED_ENABLED
        case Speed_type::WINDSPEED_AIRSPEED:
            _speed_driver = NEW_NOTHROW AP_WindVane_Airspeed(*this);
            break;
#endif
#if AP_WINDVANE_MODERNDEVICE_ENABLED
        case Speed_type::WINDVANE_WIND_SENSOR_REV_P:
            _speed_driver = NEW_NOTHROW AP_WindVane_ModernDevice(*this);
            break;
#endif
#if AP_WINDVANE_SIM_ENABLED
        case Speed_type::WINDSPEED_SITL_TRUE:
        case Speed_type::WINDSPEED_SITL_APPARENT:
            // single driver does both speed and direction
            if (_direction_type != _speed_sensor_type) {
                _speed_driver = NEW_NOTHROW AP_WindVane_SITL(*this);
            } else {
                _speed_driver = _direction_driver;
            }
            break;
#endif  // AP_WINDVANE_SIM_ENABLED
#if AP_WINDVANE_NMEA_ENABLED
        case Speed_type::WINDSPEED_NMEA:
            // single driver does both speed and direction
            if (_direction_type != WindVaneType::WINDVANE_NMEA) {
                _speed_driver = NEW_NOTHROW AP_WindVane_NMEA(*this);
                _speed_driver->init(serial_manager);
            } else {
                _speed_driver = _direction_driver;
            }
            break;
#endif  // AP_WINDVANE_NMEA_ENABLED
#if AP_WINDVANE_RPM_ENABLED
        case Speed_type::WINDSPEED_RPM:
            _speed_driver = NEW_NOTHROW AP_WindVane_RPM(*this);
            break;
#endif
    }
}

// update wind vane, expected to be called at 20hz
void AP_WindVane::update()
{
    const bool have_speed = _speed_driver != nullptr;
    const bool have_direction = _direction_driver != nullptr;

    // exit immediately if not enabled
    if (!enabled() || (!have_speed && !have_direction)) {
        return;
    }

    // calibrate if booted and disarmed
    if (!hal.util->get_soft_armed()) {
        if (_calibration == 1 && have_direction) {
            _direction_driver->calibrate();
        } else if (_calibration == 2 && have_speed) {
            _speed_driver->calibrate();
        } else if (_calibration != 0) {
            GCS_SEND_TEXT(MAV_SEVERITY_INFO, "WindVane: driver not found");
            _calibration.set_and_save(0);
        }
    } else if (_calibration != 0) {
        GCS_SEND_TEXT(MAV_SEVERITY_INFO, "WindVane: disarm for cal");
        _calibration.set_and_save(0);
    }

    // read apparent wind speed
    if (have_speed) {
        _speed_driver->update_speed();
    }

    // read apparent wind direction
    if (have_direction) {
        _direction_driver->update_direction();
    }

    if (have_speed && have_direction) {
        if (_speed_apparent >= _dir_speed_cutoff) {
            // calculate true wind speed and direction from apparent wind
            update_true_wind_speed_and_direction();
        } else {
            // assume true wind has not changed, calculate the apparent wind direction and speed
            update_apparent_wind_dir_from_true();
        }
    } else {
        // only have direction, can't do true wind calcs, set true direction to apparent + heading
        _direction_true_raw = wrap_PI(_direction_apparent_raw + AP::ahrs().get_yaw());
        _speed_true_raw = 0.0f;
    }

    /*
        Apply filters
        https://en.wikipedia.org/wiki/Mean_of_circular_quantities
    */
    float filtered_sin;
    float filtered_cos;

    // apparent speed
    if (is_positive(_speed_filt_hz)) {
        _speed_apparent_filt.set_cutoff_frequency(_speed_filt_hz);
        _speed_apparent = _speed_apparent_filt.apply(_speed_apparent_raw,0.05f);
    } else {
        _speed_apparent = _speed_apparent_raw;
    }

    // apparent direction
    if (is_positive(_dir_filt_hz)) {
        _direction_apparent_sin_filt.set_cutoff_frequency(_dir_filt_hz);
        _direction_apparent_cos_filt.set_cutoff_frequency(_dir_filt_hz);
        filtered_sin = _direction_apparent_sin_filt.apply(sinf(_direction_apparent_raw),0.05f);
        filtered_cos = _direction_apparent_cos_filt.apply(cosf(_direction_apparent_raw),0.05f);
        _direction_apparent = atan2f(filtered_sin, filtered_cos);
    } else {
        _direction_apparent = _direction_apparent_raw;
    }

    // apparent direction for tack threshold, hard coded freq
    filtered_sin = _tack_sin_filt.apply(sinf(_direction_apparent_raw),0.05f);
    filtered_cos = _tack_cos_filt.apply(cosf(_direction_apparent_raw),0.05f);
    _direction_tack = atan2f(filtered_sin, filtered_cos);
    _current_tack = is_negative(_direction_tack) ? Sailboat_Tack::TACK_PORT : Sailboat_Tack::TACK_STARBOARD;

    // true wind direction and speed, both at the same freq
    if (is_positive(_true_filt_hz)) {
        _speed_true_filt.set_cutoff_frequency(_true_filt_hz);
        _direction_true_sin_filt.set_cutoff_frequency(_true_filt_hz);
        _direction_true_cos_filt.set_cutoff_frequency(_true_filt_hz);

        _speed_true = _speed_true_filt.apply(_speed_true_raw,0.05f);
        filtered_sin = _direction_true_sin_filt.apply(sinf(_direction_true_raw),0.05f);
        filtered_cos = _direction_true_cos_filt.apply(cosf(_direction_true_raw),0.05f);
        _direction_true = atan2f(filtered_sin, filtered_cos);
    } else {
        _speed_true = _speed_true_raw;
        _direction_true = _direction_true_raw;
    }

#if HAL_LOGGING_ENABLED
// @LoggerMessage: WIND
// @Description: Windvane readings
// @Field: TimeUS: Time since system startup
// @Field: DrRaw: raw apparent wind direction direct from sensor, in body-frame
// @Field: DrApp: Apparent wind direction, in body-frame
// @Field: DrTru: True wind direction
// @Field: SpdRaw: raw wind speed direct from sensor
// @Field: SpdApp: Apparent wind Speed
// @Field: SpdTru: True wind speed
    AP::logger().WriteStreaming("WIND", "TimeUS,DrRaw,DrApp,DrTru,SpdRaw,SpdApp,SpdTru",
                        "sddhnnn", "F000000", "Qffffff",
                        AP_HAL::micros64(),
                        degrees(_direction_apparent_raw),
                        degrees(_direction_apparent),
                        degrees(_direction_true),
                        _speed_apparent_raw,
                        _speed_apparent,
                        _speed_true);
#endif

}

void AP_WindVane::record_home_heading()
{
    _home_heading = AP::ahrs().get_yaw();
}

// to start direction calibration from mavlink or other
bool AP_WindVane::start_direction_calibration()
{
    if (enabled() && (_calibration == 0)) {
        _calibration.set(1);
        return true;
    }
    return false;
}

// to start speed calibration from mavlink or other
bool AP_WindVane::start_speed_calibration()
{
    if (enabled() && (_calibration == 0)) {
        _calibration.set(2);
        return true;
    }
    return false;
}

// send mavlink wind message
void AP_WindVane::send_wind(mavlink_channel_t chan) const
{
    // exit immediately if not enabled
    if (!enabled()) {
        return;
    }

    // send wind
    mavlink_msg_wind_send(
        chan,
        wrap_360(degrees(get_true_wind_direction_rad())),
        get_true_wind_speed(),
        0);

    // send apparent wind using named floats
    // TODO: create a dedicated MAVLink message
    gcs().send_named_float("AppWndSpd", get_apparent_wind_speed());
    gcs().send_named_float("AppWndDir", degrees(get_apparent_wind_direction_rad()));

}

// calculate true wind speed and direction from apparent wind
// https://en.wikipedia.org/wiki/Apparent_wind
void AP_WindVane::update_true_wind_speed_and_direction()
{
    // if no vehicle speed, can't do calcs
    Vector3f veh_velocity;
    if (!AP::ahrs().get_velocity_NED(veh_velocity)) {
        // if no vehicle speed use apparent speed and direction directly
        _direction_true_raw = _direction_apparent_raw;
        _speed_true_raw = _speed_apparent;
        return;
    }

    // convert apparent wind speed and direction to 2D vector in same frame as vehicle velocity
    const float wind_dir_180 = _direction_apparent_raw + AP::ahrs().get_yaw() + radians(180);
    const Vector2f wind_apparent_vec(cosf(wind_dir_180) * _speed_apparent, sinf(wind_dir_180) * _speed_apparent);

    // add vehicle velocity
    Vector2f wind_true_vec = Vector2f(wind_apparent_vec.x + veh_velocity.x, wind_apparent_vec.y + veh_velocity.y);

    // calculate true speed and direction
    _direction_true_raw = wrap_PI(atan2f(wind_true_vec.y, wind_true_vec.x) - radians(180));
    _speed_true_raw = wind_true_vec.length();
}

// apparent wind is low, can't trust sensors, assume true wind has not changed and calculate apparent wind
void AP_WindVane::update_apparent_wind_dir_from_true()
{
    // if no vehicle speed, can't do calcs
    Vector3f veh_velocity;
    if (!AP::ahrs().get_velocity_NED(veh_velocity)) {
        return;
    }

    // convert true wind speed and direction to 2D vector in same frame as vehicle velocity
    const float wind_dir_180 = _direction_true + radians(180);
    const Vector2f wind_true_vec(cosf(wind_dir_180) * _speed_true, sinf(wind_dir_180) * _speed_true);

    // add vehicle velocity
    Vector2f wind_apparent_vec = Vector2f(wind_true_vec.x - veh_velocity.x, wind_true_vec.y - veh_velocity.y);

    // calculate apartment speed and direction
    _direction_apparent_raw = wrap_PI(atan2f(wind_apparent_vec.y, wind_apparent_vec.x) - radians(180) - AP::ahrs().get_yaw());
    _speed_apparent_raw = wind_apparent_vec.length();
}

AP_WindVane *AP_WindVane::_singleton = nullptr;

namespace AP {
    AP_WindVane *windvane()
    {
        return AP_WindVane::get_singleton();
    }
};

#endif  // AP_WINDVANE_ENABLED
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    /*
   This program is free software: you can redistribute it and/or modify
   it under the terms of the GNU General Public License as published by
   the Free Software Foundation, either version 3 of the License, or
   (at your option) any later version.

   This program is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU General Public License for more details.

   You should have received a copy of the GNU General Public License
   along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
#pragma once

#include "AP_WindVane_config.h"

#if AP_WINDVANE_ENABLED

#include <AP_Param/AP_Param.h>
#include <Filter/Filter.h>
#include <GCS_MAVLink/GCS_MAVLink.h>

#ifndef WINDVANE_DEFAULT_PIN
#define WINDVANE_DEFAULT_PIN -1                     // default wind vane sensor analog pin
#endif
#ifndef WINDSPEED_DEFAULT_SPEED_PIN
#define WINDSPEED_DEFAULT_SPEED_PIN -1              // default pin for reading speed from ModernDevice rev p wind sensor
#endif
#ifndef WINDSPEED_DEFAULT_TEMP_PIN
#define WINDSPEED_DEFAULT_TEMP_PIN -1               // default pin for reading temperature from ModernDevice rev p wind sensor
#endif
#define WINDSPEED_DEFAULT_VOLT_OFFSET 1.346f        // default voltage offset between speed and temp pins from ModernDevice rev p wind sensor

class AP_WindVane_Backend;

class AP_WindVane
{
    friend class AP_WindVane_Backend;
    friend class AP_WindVane_Home;
    friend class AP_WindVane_Analog;
    friend class AP_WindVane_SITL;
    friend class AP_WindVane_ModernDevice;
    friend class AP_WindVane_Airspeed;
    friend class AP_WindVane_RPM;
    friend class AP_WindVane_NMEA;

public:
    AP_WindVane();

    /* Do not allow copies */
    CLASS_NO_COPY(AP_WindVane);

    static AP_WindVane *get_singleton();

    // return true if wind vane is enabled
    bool enabled() const;

    // return true if wind speed is enabled
    bool wind_speed_enabled() const;

    // Initialize the Wind Vane object and prepare it for use
    void init(const class AP_SerialManager& serial_manager);

    // update wind vane
    void update();

    // get the apparent wind direction in body-frame in radians, 0 = head to wind
    float get_apparent_wind_direction_rad() const { return _direction_apparent; }

    // get the true wind direction in radians, 0 = wind coming from north
    float get_true_wind_direction_rad() const { return _direction_true; }

    // Return apparent wind speed
    float get_apparent_wind_speed() const { return _speed_apparent; }

    // Return true wind speed
    float get_true_wind_speed() const { return _speed_true; }

    // Return the apparent wind angle used to determin the current tack
    float get_tack_threshold_wind_dir_rad() const { return _direction_tack; }

    // enum defining current tack
    enum Sailboat_Tack {
        TACK_PORT,
        TACK_STARBOARD
    };

    // return the current tack
    Sailboat_Tack get_current_tack() const { return _current_tack; }

    // record home heading for use as wind direction if no sensor is fitted
    void record_home_heading();

    // start calibration routine
    bool start_direction_calibration();
    bool start_speed_calibration();

    // send mavlink wind message
    void send_wind(mavlink_channel_t chan) const;

    // parameter block
    static const struct AP_Param::GroupInfo var_info[];

private:

    // parameters
    AP_Int8 _direction_type;                        // type of windvane being used
    AP_Int8 _dir_analog_pin;                        // analog pin connected to wind vane direction sensor
    AP_Float _dir_analog_volt_min;                  // minimum voltage read by windvane
    AP_Float _dir_analog_volt_max;                  // maximum voltage read by windvane
    AP_Float _dir_analog_bearing_offset;            // angle offset when windvane is indicating a headwind, ie 0 degress relative to vehicle
    AP_Float _dir_analog_deadzone;                  // analog pot deadzone in degrees
    AP_Float _dir_filt_hz;                          // vane Low pass filter frequency
    AP_Int8 _calibration;                           // enter calibration
    AP_Float _dir_speed_cutoff;                     // vane cutoff wind speed
    AP_Int8 _speed_sensor_type;                     // wind speed sensor type
    AP_Int8 _speed_sensor_speed_pin;                // speed sensor analog pin for reading speed
    AP_Float _speed_sensor_temp_pin;                // speed sensor analog pin for reading temp, -1 if disable
    AP_Float _speed_sensor_voltage_offset;          // analog speed zero wind voltage offset
    AP_Float _speed_filt_hz;                        // speed sensor low pass filter frequency
    AP_Float _true_filt_hz;                         // true wind speed and direction low pass filter frequency

    AP_WindVane_Backend *_direction_driver;
    AP_WindVane_Backend *_speed_driver;

    // update wind speed sensor
    void update_apparent_wind_speed();

    // update apparent wind direction
    void update_apparent_wind_direction();

    // calculate true wind speed and direction from apparent wind
    void update_true_wind_speed_and_direction();

    // assume true wind has not changed and calculate apparent wind
    void update_apparent_wind_dir_from_true();

    // wind direction variables
    float _direction_apparent_raw;                  // wind's apparent direction in radians (0 = ahead of vehicle) in body frame
    float _direction_apparent;                      // wind's apparent direction in radians (0 = ahead of vehicle) in body frame - filtered
    float _direction_true_raw;                      // wind's true direction in radians (0 = North)
    float _direction_true;                          // wind's true direction in radians (0 = North) - filtered
    float _direction_tack;                          // filtered apparent wind used to determin the current tack
    LowPassFilterFloat _direction_apparent_sin_filt{2.0f};
    LowPassFilterFloat _direction_apparent_cos_filt{2.0f};
    LowPassFilterFloat _direction_true_sin_filt{2.0f};
    LowPassFilterFloat _direction_true_cos_filt{2.0f};
    LowPassFilterFloat _tack_sin_filt{0.1f};
    LowPassFilterFloat _tack_cos_filt{0.1f};

    // wind speed variables
    float _speed_apparent_raw;                      // wind's apparent speed in m/s
    float _speed_apparent;                          // wind's apparent speed in m/s - filtered
    float _speed_true_raw;                          // wind's true estimated speed in m/s
    float _speed_true;                              // wind's true estimated speed in m/s - filtered
    LowPassFilterFloat _speed_apparent_filt{2.0f};
    LowPassFilterFloat _speed_true_filt{2.0f};

    // current tack
    Sailboat_Tack _current_tack;

    // heading in radians recorded when vehicle was armed
    float _home_heading;

    enum WindVaneType {
        WINDVANE_NONE           = 0,
#if AP_WINDVANE_HOME_ENABLED
        WINDVANE_HOME_HEADING   = 1,
        WINDVANE_PWM_PIN        = 2,
#endif
#if AP_WINDVANE_ANALOG_ENABLED
        WINDVANE_ANALOG_PIN     = 3,
#endif
#if AP_WINDVANE_NMEA_ENABLED
        WINDVANE_NMEA           = 4,
#endif
#if AP_WINDVANE_SIM_ENABLED
        WINDVANE_SITL_TRUE      = 10,
        WINDVANE_SITL_APPARENT  = 11,
#endif
    };

    enum Speed_type {
        WINDSPEED_NONE               = 0,
#if AP_WINDVANE_AIRSPEED_ENABLED
        WINDSPEED_AIRSPEED           = 1,
#endif
        WINDVANE_WIND_SENSOR_REV_P   = 2,
#if AP_WINDVANE_RPM_ENABLED
        WINDSPEED_RPM                = 3,
#endif
#if AP_WINDVANE_NMEA_ENABLED
        WINDSPEED_NMEA               = 4,
#endif
#if AP_WINDVANE_SIM_ENABLED
        WINDSPEED_SITL_TRUE          = 10,
        WINDSPEED_SITL_APPARENT      = 11,
#endif
    };

    static AP_WindVane *_singleton;
};

namespace AP {
    AP_WindVane *windvane();
};

#endif  // AP_WINDVANE_ENABLED
                                                                                                                                                                                                      /*
   This program is free software: you can redistribute it and/or modify
   it under the terms of the GNU General Public License as published by
   the Free Software Foundation, either version 3 of the License, or
   (at your option) any later version.

   This program is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU General Public License for more details.

   You should have received a copy of the GNU General Public License
   along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */

#include "AP_WindVane_config.h"

#if AP_WINDVANE_AIRSPEED_ENABLED

#include "AP_WindVane_Airspeed.h"

void AP_WindVane_Airspeed::update_speed()
{
    const AP_Airspeed* airspeed = AP_Airspeed::get_singleton();
    if (airspeed != nullptr) {
        _frontend._speed_apparent_raw = airspeed->get_raw_airspeed();
    }
}

#endif  // AP_WINDVANE_AIRSPEED_ENABLED
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              /*
   This program is free software: you can redistribute it and/or modify
   it under the terms of the GNU General Public License as published by
   the Free Software Foundation, either version 3 of the License, or
   (at your option) any later version.

   This program is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU General Public License for more details.

   You should have received a copy of the GNU General Public License
   along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
#pragma once

#include "AP_WindVane_config.h"

#if AP_WINDVANE_AIRSPEED_ENABLED

#include "AP_WindVane_Backend.h"

#include <AP_Airspeed/AP_Airspeed.h>

class AP_WindVane_Airspeed : public AP_WindVane_Backend
{
public:
    // constructor
    using AP_WindVane_Backend::AP_WindVane_Backend;

    // update state
    void update_speed() override;
};

#endif  // AP_WINDVANE_AIRSPEED_ENABLED
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  /*
   This program is free software: you can redistribute it and/or modify
   it under the terms of the GNU General Public License as published by
   the Free Software Foundation, either version 3 of the License, or
   (at your option) any later version.

   This program is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU General Public License for more details.

   You should have received a copy of the GNU General Public License
   along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */

#include "AP_WindVane_config.h"

#if AP_WINDVANE_ANALOG_ENABLED

#include "AP_WindVane_Analog.h"

#include <AP_HAL/AP_HAL.h>
#include <GCS_MAVLink/GCS.h>

extern const AP_HAL::HAL& hal;

#define WINDVANE_CALIBRATION_VOLT_DIFF_MIN  1.0f    // calibration routine's min voltage difference required for success

#include <AP_HAL/AP_HAL.h>

extern const AP_HAL::HAL& hal;

// constructor
AP_WindVane_Analog::AP_WindVane_Analog(AP_WindVane &frontend) :
    AP_WindVane_Backend(frontend)
{
    _dir_analog_source = hal.analogin->channel(ANALOG_INPUT_NONE);
}

void AP_WindVane_Analog::update_direction()
{
    if (!_dir_analog_source->set_pin(_frontend._dir_analog_pin)) {
        // pin invalid, don't have health monitoring to report yet
        return;
    }
    _current_analog_voltage = _dir_analog_source->voltage_latest();

    const float voltage_ratio = linear_interpolate(0.0f, 1.0f, _current_analog_voltage, _frontend._dir_analog_volt_min, _frontend._dir_analog_volt_max);
    const float direction = (voltage_ratio * radians(360 - _frontend._dir_analog_deadzone)) + radians(_frontend._dir_analog_bearing_offset);

    _frontend._direction_apparent_raw  = wrap_PI(direction);
}

void AP_WindVane_Analog::calibrate()
{

    // start calibration
    if (_cal_start_ms == 0) {
        _cal_start_ms = AP_HAL::millis();
        _cal_volt_max = _current_analog_voltage;
        _cal_volt_min = _current_analog_voltage;
        GCS_SEND_TEXT(MAV_SEVERITY_INFO, "WindVane: Calibration started, rotate wind vane");
    }

    // record min and max voltage
    _cal_volt_max = MAX(_cal_volt_max, _current_analog_voltage);
    _cal_volt_min = MIN(_cal_volt_min, _current_analog_voltage);

    // calibrate for 30 seconds
    if ((AP_HAL::millis() - _cal_start_ms) > 30000) {
        // check for required voltage difference
        const float volt_diff = _cal_volt_max - _cal_volt_min;
        if (volt_diff >= WINDVANE_CALIBRATION_VOLT_DIFF_MIN) {
            // save min and max voltage
            _frontend._dir_analog_volt_max.set_and_save(_cal_volt_max);
            _frontend._dir_analog_volt_min.set_and_save(_cal_volt_min);
            GCS_SEND_TEXT(MAV_SEVERITY_INFO, "WindVane: Calibration complete (volt min:%.1f max:%1.f)",
            (double)_cal_volt_min,
            (double)_cal_volt_max);
        } else {
             GCS_SEND_TEXT(MAV_SEVERITY_INFO, "WindVane: Calibration failed (volt diff %.1f below %.1f)",
            (double)volt_diff,
            (double)WINDVANE_CALIBRATION_VOLT_DIFF_MIN);
        }
        _frontend._calibration.set_and_save(0);
        _cal_start_ms = 0;
    }
}

#endif  // AP_WINDVANE_ANALOG_ENABLED
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               /*
   This program is free software: you can redistribute it and/or modify
   it under the terms of the GNU General Public License as published by
   the Free Software Foundation, either version 3 of the License, or
   (at your option) any later version.

   This program is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU General Public License for more details.

   You should have received a copy of the GNU General Public License
   along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */

#include "AP_WindVane_config.h"

#if AP_WINDVANE_ENABLED

#include "AP_WindVane.h"
#include "AP_WindVane_Backend.h"

#include <GCS_MAVLink/GCS.h>

// base class constructor.
AP_WindVane_Backend::AP_WindVane_Backend(AP_WindVane &frontend) :
        _frontend(frontend)
{
}

// calibrate WindVane
void AP_WindVane_Backend::calibrate()
{
    GCS_SEND_TEXT(MAV_SEVERITY_INFO, "WindVane: No cal required");
    _frontend._calibration.set_and_save(0);
    return;
}

#endif  // AP_WINDVANE_ENABLED
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          /*
   This program is free software: you can redistribute it and/or modify
   it under the terms of the GNU General Public License as published by
   the Free Software Foundation, either version 3 of the License, or
   (at your option) any later version.

   This program is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU General Public License for more details.

   You should have received a copy of the GNU General Public License
   along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
#pragma once

#include "AP_WindVane_config.h"

#if AP_WINDVANE_ENABLED

#include "AP_WindVane.h"

class AP_WindVane_Backend
{
public:
    // constructor. This incorporates initialization as well.
    AP_WindVane_Backend(AP_WindVane &frontend);

    // we declare a virtual destructor so that WindVane drivers can
    // override with a custom destructor if need be
    virtual ~AP_WindVane_Backend() {}

    // initialization
    virtual void init(const AP_SerialManager& serial_manager) {};

    // update the state structure
    virtual void update_speed() {};
    virtual void update_direction() {};
    virtual void calibrate();

protected:

    AP_WindVane &_frontend;

};

#endif  // AP_WINDVANE_ENABLED
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 /*
   This program is free software: you can redistribute it and/or modify
   it under the terms of the GNU General Public License as published by
   the Free Software Foundation, either version 3 of the License, or
   (at your option) any later version.

   This program is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU General Public License for more details.

   You should have received a copy of the GNU General Public License
   along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */

#include "AP_WindVane_config.h"

#if AP_WINDVANE_HOME_ENABLED

#include "AP_WindVane_Home.h"

#include <AP_AHRS/AP_AHRS.h>

void AP_WindVane_Home::update_direction()
{
    float direction_apparent_ef = _frontend._home_heading;

    if (_frontend._direction_type == _frontend.WINDVANE_PWM_PIN) {
        RC_Channel *chan = rc().find_channel_for_option(RC_Channel::AUX_FUNC::WIND_VANE_DIR_OFSSET);
        if (chan != nullptr) {
            direction_apparent_ef += chan->norm_input() * radians(45);
        }
    }

    _frontend._direction_apparent_raw = wrap_PI(direction_apparent_ef - AP::ahrs().get_yaw());
}

#endif  // AP_WINDVANE_HOME_ENABLED
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             /*
   This program is free software: you can redistribute it and/or modify
   it under the terms of the GNU General Public License as published by
   the Free Software Foundation, either version 3 of the License, or
   (at your option) any later version.

   This program is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU General Public License for more details.

   You should have received a copy of the GNU General Public License
   along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
#pragma once

#include "AP_WindVane_config.h"

#if AP_WINDVANE_HOME_ENABLED

#include "AP_WindVane_Backend.h"
#include <RC_Channel/RC_Channel.h>

class AP_WindVane_Home : public AP_WindVane_Backend
{
public:
    // constructor
    using AP_WindVane_Backend::AP_WindVane_Backend;

    // update state
    void update_direction() override;
};

#endif  // AP_WINDVANE_HOME_ENABLED
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             /*
   This program is free software: you can redistribute it and/or modify
   it under the terms of the GNU General Public License as published by
   the Free Software Foundation, either version 3 of the License, or
   (at your option) any later version.

   This program is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU General Public License for more details.

   You should have received a copy of the GNU General Public License
   along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */

#include "AP_WindVane_config.h"

#if AP_WINDVANE_MODERNDEVICE_ENABLED

#include "AP_WindVane_ModernDevice.h"
// read wind speed from Modern Device rev p wind sensor
// https://moderndevice.com/news/calibrating-rev-p-wind-sensor-new-regression/

#include <AP_HAL/AP_HAL.h>
#include <GCS_MAVLink/GCS.h>

extern const AP_HAL::HAL& hal;

// constructor
AP_WindVane_ModernDevice::AP_WindVane_ModernDevice(AP_WindVane &frontend) :
    AP_WindVane_Backend(frontend)
{
    _speed_analog_source = hal.analogin->channel(ANALOG_INPUT_NONE);
    _temp_analog_source = hal.analogin->channel(ANALOG_INPUT_NONE);
}

void AP_WindVane_ModernDevice::update_speed()
{
    float analog_voltage = 0.0f;

    // only read temp pin if defined, sensor will do OK assuming constant temp
    float temp_ambient = 28.0f; // equations were generated at this temp in above data sheet
    if (is_positive(_frontend._speed_sensor_temp_pin.get())) {
        if (!_temp_analog_source->set_pin(_frontend._speed_sensor_temp_pin.get())) {
            // pin invalid, don't have health monitoring to report yet
            return;
        }
        analog_voltage = _temp_analog_source->voltage_average();
        temp_ambient = (analog_voltage - 0.4f) / 0.0195f; // deg C
        // constrain to reasonable range to avoid deviating from calibration too much and potential divide by zero
        temp_ambient = constrain_float(temp_ambient, 10.0f, 40.0f);
    }

    if (!_speed_analog_source->set_pin(_frontend._speed_sensor_speed_pin.get())) {
        // pin invalid, don't have health monitoring to report yet
        return;
    }
    _current_analog_voltage = _speed_analog_source->voltage_average();

    // apply voltage offset and make sure not negative
    // by default the voltage offset is the number provide by the manufacturer
    analog_voltage = _current_analog_voltage - _frontend._speed_sensor_voltage_offset;
    if (is_negative(analog_voltage)) {
        analog_voltage = 0.0f;
    }

    // simplified equation from data sheet, converted from mph to m/s
    _frontend._speed_apparent_raw  = 24.254896f * powf((analog_voltage / powf(temp_ambient, 0.115157f)), 3.009364f);
}

void AP_WindVane_ModernDevice::calibrate()
{
    GCS_SEND_TEXT(MAV_SEVERITY_INFO, "WindVane: rev P. zero wind voltage offset set to %.1f",double(_current_analog_voltage));
    _frontend._speed_sensor_voltage_offset.set_and_save(_current_analog_voltage);
    _frontend._calibration.set_and_save(0);
}

#endif  // AP_WINDVANE_MODERNDEVICE_ENABLED
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               /*
   This program is free software: you can redistribute it and/or modify
   it under the terms of the GNU General Public License as published by
   the Free Software Foundation, either version 3 of the License, or
   (at your option) any later version.

   This program is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU General Public License for more details.

   You should have received a copy of the GNU General Public License
   along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
#pragma once

#include "AP_WindVane_config.h"

#if AP_WINDVANE_MODERNDEVICE_ENABLED

#include "AP_WindVane_Backend.h"

class AP_WindVane_ModernDevice : public AP_WindVane_Backend
{
public:
    // constructor
    AP_WindVane_ModernDevice(AP_WindVane &frontend);

    // update state
    void update_speed() override;
    void calibrate() override;

private:
    float _current_analog_voltage;

    // pin for reading analog voltage
    AP_HAL::AnalogSource *_speed_analog_source;
    AP_HAL::AnalogSource *_temp_analog_source;
};

#endif  // AP_WINDVANE_MODERNDEVICE_ENABLED
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         /*
   This program is free software: you can redistribute it and/or modify
   it under the terms of the GNU General Public License as published by
   the Free Software Foundation, either version 3 of the License, or
   (at your option) any later version.

   This program is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU General Public License for more details.

   You should have received a copy of the GNU General Public License
   along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */

#include "AP_WindVane_config.h"

#if AP_WINDVANE_NMEA_ENABLED

#include <AP_HAL/AP_HAL.h>
#include "AP_WindVane_NMEA.h"
#include <AP_SerialManager/AP_SerialManager.h>

/*
    NMEA wind vane library, tested with Calypso Wired sensor,
    should also work with other NMEA wind sensors using the MWV message,
    heavily based on RangeFinder NMEA library
*/

// init - performs any required initialization for this instance
void AP_WindVane_NMEA::init(const AP_SerialManager& serial_manager)
{
    uart = serial_manager.find_serial(AP_SerialManager::SerialProtocol_WindVane, 0);
    if (uart != nullptr) {
        uart->begin(serial_manager.find_baudrate(AP_SerialManager::SerialProtocol_WindVane, 0));
    }
}

void AP_WindVane_NMEA::update_direction()
{
    // Only call update from here if it has not been called already by update speed
    if (_frontend._speed_sensor_type.get() != _frontend.Speed_type::WINDSPEED_NMEA) {
        update();
    }
}

void AP_WindVane_NMEA::update_speed()
{
    update();
}

void AP_WindVane_NMEA::update()
{
    if (uart == nullptr) {
        return;
    }

    // read any available lines from the windvane
    int16_t nbytes = uart->available();
    while (nbytes-- > 0) {
        char c = uart->read();
        if (decode(c)) {
            // user may not have NMEA selected for both speed and direction
            if (_frontend._direction_type.get() == _frontend.WindVaneType::WINDVANE_NMEA) {
                _frontend._direction_apparent_raw = wrap_PI(radians(_wind_dir_deg + _frontend._dir_analog_bearing_offset.get()));
            }
            if (_frontend._speed_sensor_type.get() == _frontend.Speed_type::WINDSPEED_NMEA) {
                _frontend._speed_apparent_raw = _speed_ms;
            }
        }
    }
}

// add a single character to the buffer and attempt to decode
// returns true if a complete sentence was successfully decoded
bool AP_WindVane_NMEA::decode(char c)
{
    switch (c) {
    case ',':
        // end of a term, add to checksum
        _checksum ^= c;
        FALLTHROUGH;
    case '\r':
    case '\n':
    case '*':
    {
        if (_sentence_done) {
            return false;
        }

        // null terminate and decode latest term
        _term[_term_offset] = 0;
        bool valid_sentence = decode_latest_term();

        // move onto next term
        _term_number++;
        _term_offset = 0;
        _term_is_checksum = (c == '*');
        return valid_sentence;
    }

    case '$': // sentence begin
        _sentence_valid = false;
        _term_number = 0;
        _term_offset = 0;
        _checksum = 0;
        _term_is_checksum = false;
        _wind_dir_deg = -1.0f;
        _speed_ms = -1.0f;
        _sentence_done = false;
        return false;
    }

    // ordinary characters are added to term
    if (_term_offset < sizeof(_term) - 1) {
        _term[_term_offset++] = c;
    }
    if (!_term_is_checksum) {
        _checksum ^= c;
    }

    return false;
}

// decode the most recently consumed term
// returns true if new sentence has just passed checksum test and is validated
bool AP_WindVane_NMEA::decode_latest_term()
{
    // handle the last term in a message
    if (_term_is_checksum) {
        _sentence_done = true;
        uint8_t checksum = 16 * char_to_hex(_term[0]) + char_to_hex(_term[1]);
        return ((checksum == _checksum) && _sentence_valid);
    }

    // the first term determines the sentence type
    if (_term_number == 0) {
        // the first two letters of the NMEA term are the talker ID.
        // we accept any two characters here.
        if (_term[0] < 'A' || _term[0] > 'Z' ||
            _term[1] < 'A' || _term[1] > 'Z') {
             // unknown ID (we are actually expecting II)
            return false;
        }
        const char *term_type = &_term[2];
        if (strcmp(term_type, "MWV") == 0) {
            // we found the sentence type for wind
            _sentence_valid = true;
        }
        return false;
    }

    // if this is not the sentence we want then wait for another
    if (!_sentence_valid) {
        return false;
    }

    switch (_term_number) {
        case 1:
            _wind_dir_deg = strtof(_term, NULL);
            // check for sensible value
            if (is_negative(_wind_dir_deg) || _wind_dir_deg > 360.0f) {
                _sentence_valid = false;
            }
            break;

        case 2:
            // we are expecting R for relative wind 
            // (could be T for true wind, maybe add in the future...)
            if (_term[0] != 'R') {
                _sentence_valid = false;
            }
            break;

        case 3:
            _speed_ms = strtof(_term, NULL);
            break;

        case 4:
            if (_term[0] == 'K') {
                // convert from km/h to m/s
                _speed_ms *= KM_PER_HOUR_TO_M_PER_SEC;
            } else if (_term[0] == 'N') {
                // convert from Knots to m/s
                _speed_ms *= KNOTS_TO_M_PER_SEC;
            }
            // could also be M for m/s, but we want that anyway so nothing to do
            // check for sensible value
            if (is_negative(_speed_ms) || _speed_ms > 100.0f) {
                _sentence_valid = false;
            }
            break;

        case 5:
            // expecting A for data valid
            if (_term[0] != 'A') {
                _sentence_valid = false;
            }
            break;

    }
    return false;
}

#endif  // AP_WINDVANE_NMEA_ENABLED
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          /*
   This program is free software: you can redistribute it and/or modify
   it under the terms of the GNU General Public License as published by
   the Free Software Foundation, either version 3 of the License, or
   (at your option) any later version.

   This program is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU General Public License for more details.

   You should have received a copy of the GNU General Public License
   along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
#pragma once

#include "AP_WindVane_config.h"

#if AP_WINDVANE_NMEA_ENABLED

#include "AP_WindVane_Backend.h"

class AP_WindVane_NMEA : public AP_WindVane_Backend
{
public:
    // constructor
    using AP_WindVane_Backend::AP_WindVane_Backend;

    // initialization
    void init(const AP_SerialManager& serial_manager) override;

    // update state
    void update_direction() override;
    void update_speed() override;

private:
    // pointer to serial uart
    AP_HAL::UARTDriver *uart = nullptr; 

    // See if we can read in some data
    void update();

    // try and decode NMEA message
    bool decode(char c);

    // decode each term
    bool decode_latest_term();

    // latest values read in
    float _speed_ms;
    float _wind_dir_deg;

    char _term[15];            // buffer for the current term within the current sentence
    uint8_t _term_offset;      // offset within the _term buffer where the next character should be placed
    uint8_t _term_number;      // term index within the current sentence
    uint8_t _checksum;         // checksum accumulator
    bool _term_is_checksum;    // current term is the checksum
    bool _sentence_valid;      // is current sentence valid so far
    bool _sentence_done;       // true if this sentence has already been decoded
};

#endif  // AP_WINDVANE_NMEA_ENABLED
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 /*
   This program is free software: you can redistribute it and/or modify
   it under the terms of the GNU General Public License as published by
   the Free Software Foundation, either version 3 of the License, or
   (at your option) any later version.

   This program is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU General Public License for more details.

   You should have received a copy of the GNU General Public License
   along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */

#include "AP_WindVane_RPM.h"

#include "AP_WindVane_config.h"

#if AP_WINDVANE_RPM_ENABLED

#include <AP_RPM/AP_RPM.h>

void AP_WindVane_RPM::update_speed()
{
    const AP_RPM* rpm = AP_RPM::get_singleton();
    if (rpm != nullptr) {
        float temp_speed;
        if (rpm->get_rpm(0, temp_speed) &&
            !is_negative(temp_speed)) {
            _frontend._speed_apparent_raw = temp_speed;
        }
    }
}

#endif  // AP_WINDVANE_RPM_ENABLED
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 /*
   This program is free software: you can redistribute it and/or modify
   it under the terms of the GNU General Public License as published by
   the Free Software Foundation, either version 3 of the License, or
   (at your option) any later version.

   This program is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU General Public License for more details.

   You should have received a copy of the GNU General Public License
   along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
#pragma once

#include "AP_WindVane_config.h"

#if AP_WINDVANE_RPM_ENABLED

#include "AP_WindVane_Backend.h"

class AP_WindVane_RPM : public AP_WindVane_Backend
{
public:
    // constructor
    using AP_WindVane_Backend::AP_WindVane_Backend;

    // update state
    void update_speed() override;
};

#endif  // AP_WINDVANE_RPM_ENABLED
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       /*
   This program is free software: you can redistribute it and/or modify
   it under the terms of the GNU General Public License as published by
   the Free Software Foundation, either version 3 of the License, or
   (at your option) any later version.

   This program is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU General Public License for more details.

   You should have received a copy of the GNU General Public License
   along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */

#include "AP_WindVane_config.h"

#if AP_WINDVANE_SIM_ENABLED

#include "AP_WindVane_SITL.h"

#include <SITL/SITL.h>
#include <AP_AHRS/AP_AHRS.h>

void AP_WindVane_SITL::update_direction()
{
    if (_frontend._direction_type == _frontend.WindVaneType::WINDVANE_SITL_TRUE) {
        // read in the true wind direction and calculate the apparent

        // temporarily store true speed and direction for easy access
        const float wind_speed = AP::sitl()->wind_speed_active;
        const float wind_dir_rad = radians(AP::sitl()->wind_direction_active);

        // Note than the SITL wind direction is defined as the direction the wind is traveling to
        // This is accounted for in these calculations

        // convert true wind speed and direction into a 2D vector
        Vector2f wind_vector_ef(cosf(wind_dir_rad) * wind_speed, sinf(wind_dir_rad) * wind_speed);

        // add vehicle speed to get apparent wind vector
        wind_vector_ef.x += AP::sitl()->state.speedN;
        wind_vector_ef.y += AP::sitl()->state.speedE;

        _frontend._direction_apparent_raw =  wrap_PI(atan2f(wind_vector_ef.y, wind_vector_ef.x) - AP::ahrs().get_yaw());

    } else { // WINDVANE_SITL_APARRENT
        // directly read the body frame apparent wind set by physics backend
        _frontend._direction_apparent_raw =  wrap_PI(AP::sitl()->get_apparent_wind_dir());
    }

}

void AP_WindVane_SITL::update_speed()
{
    if (_frontend._speed_sensor_type == _frontend.Speed_type::WINDSPEED_SITL_TRUE) {
        // read in the true wind direction and calculate the apparent

        // temporarily store true speed and direction for easy access
        const float wind_speed = AP::sitl()->wind_speed_active;
        const float wind_dir_rad = radians(AP::sitl()->wind_direction_active);

        // convert true wind speed and direction into a 2D vector
        Vector2f wind_vector_ef(cosf(wind_dir_rad) * wind_speed, sinf(wind_dir_rad) * wind_speed);

        // add vehicle speed to get apparent wind vector
        wind_vector_ef.x += AP::sitl()->state.speedN;
        wind_vector_ef.y += AP::sitl()->state.speedE;

        _frontend._speed_apparent_raw = wind_vector_ef.length();

    } else { // WINDSPEED_SITL_APARRENT
        // directly read the apparent wind from as set by physics backend
        _frontend._speed_apparent_raw = AP::sitl()->get_apparent_wind_spd();
    }
}
#endif  // AP_WINDVANE_SIM_ENABLED
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             /*
   This program is free software: you can redistribute it and/or modify
   it under the terms of the GNU General Public License as published by
   the Free Software Foundation, either version 3 of the License, or
   (at your option) any later version.

   This program is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU General Public License for more details.

   You should have received a copy of the GNU General Public License
   along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
#pragma once

#include "AP_WindVane_config.h"

#if AP_WINDVANE_SIM_ENABLED

#include "AP_WindVane_Backend.h"

class AP_WindVane_SITL : public AP_WindVane_Backend
{
public:

    // constructor
    using AP_WindVane_Backend::AP_WindVane_Backend;

    // update state
    void update_direction() override;
    void update_speed() override;
};

#endif  // AP_WINDVANE_SIM_ENABLED
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               #pragma once

#include <AP_HAL/AP_HAL_Boards.h>

#include <AP_Airspeed/AP_Airspeed_config.h>
#include <AP_RPM/AP_RPM_config.h>

#ifndef AP_WINDVANE_ENABLED
#define AP_WINDVANE_ENABLED 1
#endif

#ifndef AP_WINDVANE_BACKEND_DEFAULT_ENABLED
#define AP_WINDVANE_BACKEND_DEFAULT_ENABLED AP_WINDVANE_ENABLED
#endif

#ifndef AP_WINDVANE_AIRSPEED_ENABLED
#define AP_WINDVANE_AIRSPEED_ENABLED AP_WINDVANE_BACKEND_DEFAULT_ENABLED && AP_AIRSPEED_ENABLED
#endif

#ifndef AP_WINDVANE_ANALOG_ENABLED
#define AP_WINDVANE_ANALOG_ENABLED AP_WINDVANE_BACKEND_DEFAULT_ENABLED
#endif

#ifndef AP_WINDVANE_HOME_ENABLED
#define AP_WINDVANE_HOME_ENABLED AP_WINDVANE_BACKEND_DEFAULT_ENABLED
#endif

#ifndef AP_WINDVANE_MODERNDEVICE_ENABLED
#define AP_WINDVANE_MODERNDEVICE_ENABLED AP_WINDVANE_BACKEND_DEFAULT_ENABLED
#endif

#ifndef AP_WINDVANE_NMEA_ENABLED
#define AP_WINDVANE_NMEA_ENABLED AP_WINDVANE_BACKEND_DEFAULT_ENABLED
#endif

#ifndef AP_WINDVANE_RPM_ENABLED
#define AP_WINDVANE_RPM_ENABLED AP_WINDVANE_BACKEND_DEFAULT_ENABLED && AP_RPM_ENABLED
#endif

#ifndef AP_WINDVANE_SIM_ENABLED
#define AP_WINDVANE_SIM_ENABLED AP_WINDVANE_BACKEND_DEFAULT_ENABLED && AP_SIM_ENABLED
#endif
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       JFIF  ` `   Exif  MM *         8      	         1    &   Ji       p    Android TP1A.220624.014.S908BXXU2BVKB                            417     2022:12:18 21:13:30 +00:00     JFIF      (ICC_PROFILE       0  mntrRGB XYZ             acsp                                  -                                                   	desc      trXYZ  d   gXYZ  x   bXYZ     rTRC     (gTRC     (bTRC     (wtpt     cprt     <mluc          enUS   X    s R G B                                                                                XYZ       o  8  XYZ       b    XYZ       $    para        ff    Y    
[        XYZ            -mluc          enUS        G o o g l e   I n c .   2 0 1 6 C 		



	 C 7"            	
    } !1AQa"q2#BR$3br	
%&'()*456789:CDEFGHIJSTUVWXYZcdefghijstuvwxyz        	
   w !1AQaq"2B	#3Rbr
$4%&'()*56789:CDEFGHIJSTUVWXYZcdefghijstuvwxyz   ? OGB(  ( +OGB(  ( ((>? Q 4d'OObOGB(  ( ((>? Q 4d'OObOGB(  ( ((>? Q 4d'OObOGB(  ( ((>? Q 4d'OObOGB(  ( ((>? Q 4d'OObOGB(  ( ((>? Q 4d'OObOGB(  ( ((>? Q 4d'OObOGB(  ( ((>? Q 4d'OObOGB(  ( ((>? Q 4d'OObOGB(  ( ((>? Q 4d'OObOGB(  ( ((>? Q 4d'OObOGB(  ( ((>? Q 4d'OObOGB(  ( ((>? Q 4d'OObOGB(  ( ((>? Q 4d'OObOGB(  ( ((>? Q 4d'OObOGB(  ( ((>? Q 4d'OObOGB(  ( ((>? Q 4d'OObOGB(  ( ((>? Q 4d'OObOGB(  ( ((>? Q 4d'OObOGB(  ( ((>? Q 4d'OObOGB(  ( ((>? Q 4d'OObOGB(  ( ((>? Q 4d'OObOGB(  ( ((>? Q 4d'OObOGB(  ( ((>? Q 4d'OObOGB(  ( ((>? Q 4d'OObOGB(  ( ((>? Q 4d'OObOGB(  ( ((>? Q 4d'OObOGB(  ( ((>? Q 4d'OObOGB(  ( ((>? Q 4d'OObOGB(  ( ((>? Q 4d'OObOGB(  ( ((>? Q 4d'OObOGB(  ( ((>? Q 4d'OObOGB(  ( ((>? Q 4d'OObOEn}z~QPEEZW^__
EEZhU(*GG({BGVj|0b0X ^~e m-	V-w yG\.Xms>'\[Y}=
.+[D?J1KQ bGVj<jNT~-
EEZ*yk f({BGVj<j|=W^_?j9P{BGVj<j9P{BGVj<j\
EEZ*yk=W^__
EEZhU(*GG({BGVj<j9C|<QQQU//P_""y~y~r*yk=W^__
EEZhU(*GG({BGVj<j9C|<QQQU//P_""y~y~r*yk=W^__
EEZhU(*GG({BGVj<j9C|<QQQU//P_""y~y~r*yk=W^__
EEZhU(*GG({BGVj<j9C|<QQQU//P_""y~y~r*yk=W^__
EEZhU(*GG({BGVj<j9C|<QQQU//P_""y~y~r*yk=W^__
EEZ|j9P{BGVj<j\U(*GO=W^__
EEZhU(*GG({BGVj6g
EEZ1QQQU//TQU//P_""y~y~r*U/\OQR[	QRG}KRYf#n5a&|d88foWeF_oO}55r~ g:zQW/;[/j1h k|% =C 2r/9 wR]GaBzxJs_|axV.^MD$!<^-k*iF(=/+ApQbTe\A+DR^I<,c&;?ZIQwMw?1>/<.**TzLR]oGUC~5o`g!f,?C["#+|r[ 8!<XzTFa6
6
Z+>4M [4+A_qFvqN cu,?K*JEIA;z/BH+KF}VfU?k+C&<17) x?
~,~^&g|hG$j#A^ES thzUkirGc^?h_YX}QcMK p)I&u$wnY~e<cF:m:uJ+WI6>rf}VH~%jz]Qf$(e~>=/_v m}&-=b,Za#T N>_eXoxZ(G,Im9'e?|i?+_]ZptmjAC}U,q'8KVnuZ3`ESz[G*x^,a{n.VGK`q f| 1 ViPkHB~ |_Ok xZm5b<#zxEVG&ZOwV%P4{Zis |4ogO^j=NX8$+(k9=FYXa)k8Ryknw?.Zv"ztIY]tBllW	QR@	QR@	QR@	QR@	QR@	QR@	QR@	QR@	QR@	QR@	QW?Mh=,u+N,GQ\FI s_uj
^/m*8[9;']O8OFy hqVi}MW`~&[O	&qm'1c\#I9w,FI# /^p*m{	,f+F*{-`h:
CiJTi2<A W?fvXdeu)
pA^4?gkkcbiUPTM7}/()h>ydM [7]{Bq3gnq}7fOx->= _q,$98TT~^s1e}z[(_HO
- 
go'I&#Kx! #jy)acE]8
.Xa4VI_fFKSXXCkm\HE#P;HWgc (+n ixohFFg"[#w>q,16\M2.Z6WN%4%?b|8uZXrWQwomm ^btSbY	 $pu}^K:}4igMLeNllW|- - - - - - - - - - - - - - - - - - - - - j;uve%HD^Pg0^-	nf8= '+~|&Hn!q#*'L|cV)*+S5_Io'~w"7<qDJ!>:n{(qu"Y'|kMKb27x#8z<38p}'Kp~!b0x5'~'x.t:]!y6."EL|aUwVSC
+G}a[Rw}T	J?{kWf#P}v)B\a=bTrk$nGTcq/T6>< !$1eSt_ ek?\L|7
IV\2 8u8wS"j|~MtG[8Y7+x^\hwZZMRHN
<5_?=g^xnRWF>cr0*O?ikFxY-af&FKE{QR@	QR@'{k_Yoi>yJ/V:}'lq~$W;m8xj(o-Wx:Dr *?L<' ~Y*qwW
;j\?G-=xoB9-mW52on%s G$ci_>'K){,._OmSoM'Wf<wm+ [kivkW >cT7WF/!={~?~M#dC|}yx,b%NNfm9^2SW>> ()JJgm()h(
(
eiX&W i~L5"yye#=q5a0.i->h S oOB_ - G;E1  ?_?=* !y h S ov?cQ g Qoj?!O  Oj2l0eb_.'-/;q_ eWx
bc(:Q9c:U)wy</}69oKR9k{E9*/;s_iGg;GmLd Wz}kNzg?T20deQIw@B
0 EWbc?'RnwmovQEQ^"~,H? _y^W|f+zO^i kl
ynsO,~uqk7_o3>9Zk*v EOKX_:WVe, %9
 _j6?
uN&kE~ZB-;K}fI2YY3V<A0/tZ?	|'F2YZ}_DK/2\M-R]RGo C iWMrw+)1) :~i|MX+oqw/2,#2VSB*>~?}y{|y?7#k mjSYa
7)%\IGtJX)lM<z +VE }f[_ksCo[)T::y|) "/nO<|n >7ThIfrfdWqi~"KEN{N+]t{?;|e:_>X)=4_?oxuYMn!9c(Wh}-c~_:_	5Q
#(k8g_RK uc\SOOEWQE QE QE QE QE QE QE QE QE QE }'   % jk f W ] F_yX|.~!ypvI*<(^ix.
m?6bxX/}]F;{[6XR02L2\"A?koi Yu$jl ieBalG,|MkE\L#j.M[K>5mO9X*=	 qL*O c&KWs+Olw,zWW?F_Ky,:xJx^GGR.Gb=+#j/kGx0[ mg]Q_R,_}  ^ F>DMbhu3$Ip$ $^{  _YbE5f!ao,ObaUI.uUPi~Z=x WPokki)
I+)AAg C C3  WW_Zx[	<OXi_29'wF FT8g8ckN87QWN_]?=9qid9ok?iN07D4f{yVH2YN
_UyNO$/:nxXnV++[yG=z6C-%xc=73E6z1=q ?F> 5
#!V*''_Uxw?M6JE6V_`cxrpFi8:cR+DGt~YX<g^-PZiDO-yq0 pORI<1rM4#E, Oj yh:x&tf6qoz2US>p	r<	o-v5<1ln3, *cA6]/Uf?59RV rl| Xj,|e60A%?*79zK2.O[c{O+ l.Olo%UA*p:3G |Vm3#[+$PkrM0yc} 98;RoV#X'<:6ILle['?H- L]_ZEq -H2da>}k+~\TMFY>kJ[q}wn>V^|vY+AmH5kE>U 92<hgQ=hO~N_+?= r*ypgnlmc	'4]?~'#K>#R_!6tcw"@pq8'O
>ylH|PH,rI KVi2586$xC4YVSVA<xzWjk_>a fMnZmOX3bm}1^	s@t\K&@9%.	$@ #_I~?V5$VBl 3Z7}[21gY,0SEv8WG	,3nV+'ctO$uo%E|[~]GT2A0?`/+,{VKc%n,` *CO9]ES/.$Ei4i$r\F~59p0YNe&Zpf3W47M;=SwOW{&~&M[Z-6'd16n>H  h:WtPdFc  CR|Y `am+PCivvzz--x<JY`nsdYgNM|VOoI/	E">%%K&{##=/e&9 08aD~_W>3Y.oKy!xY T's).^\HiHX#g990]:3Nj5fgws<i=+JPEI< 	8?$7Z<w27s(ckdum{g=W5K$sJGPf.|3Xm9C`;s]|Kf:zky|2o|0JmV ~'%cd>#tjY`B<sMoz~<;'VQ0y~ +5]EXI*88hrAHEx'kFYG0a%]UU=8/.y*(=4zm\ g& -|<Gj(U,Jqrk MjX5W6UZE+FX6~S ??~?S-/JKqcT0y'[rm{v}F?xWas\cmd<|30O}ZMbu#H=sk8~^"5Crq/"/-HX2~c8"V088{Obsr|tVNEW|QE QE QE QE QE QE QE QE QE QE7xCTuQVJKtp{0egMk_PD{k@n^>Y5a`W3X]7 |?%v7pI@<|gjx Z,|	f<a'kKulU;9N?%[I*7NGmv}]aVi:oW9Oi:AbShq%UL8?*z?5}f5[{}n#| zU |AZ;a5Juw6@/<Kl7AiC
@%#lfzrv^ZLh)Z1W|]z/1x#E#]i (U\YB5(t_GKmRYcK1$ :^[}u2L1 Wiiy0tO(r^NDoqq_ql~:BPKlhFTrrOuK J#>j,f_Z#o?V,kGevqvZ-d|
yy'4 4A^EM4~a[nR9/d4<qyn;&SR2NQj+|( ( 	WCaB[!Pkq[m
@z-%0T']rh73+/|Z[9[(}m~z=$xN?/{-8M|uYh6q]%Z ~ag}^)$`  :>${_w?8E=|)3I]*ZyYn n5_aoa~rf&xQEqQ@Q@i5|3n#odxUHR9sY=xciqcD[)cD)F!ryyca|Z.o'f4-<ff  A ;^, ?g k?|  q_1
 W  U|U C7?c7 _u~ k ;^, ?C  A   Wff  A ;^, ?g h ]_ ?gO4GRD,\<^qn'*{ +aZv\mom9j
aA?2f]R;(( +o'fr_;ZdMecwn8 t5g!^x Jk:yTVKuGxs[=NOg&$<ACh~q$~&T3q^K&\|:565+2KF~%x74k9hS' xMsA)%<b2$gJXxVo.Y8x\BmAZIjT|8~;_M}1uc9^n^wC
LijH"F1+.d s}'z|M[ZKTtJXoV%:.Wxyc_scxRh!7waUMnxl59AJ]RS[}XZ~c`Qp$(o7}<x[
xwZ}x>f'W*g|UZo;|3y/'exPo.>L2ay/*/438c#4%kKEtksr[_t}-^u0XM L}_M cXY\Mf$(U=@55}/,"%f|OtWpVo +
(
(
(
(
(
(
(
(
(
(> W  F_O H4g_.kb#3#J9`>!Y-YMHXV98
3g? U=2)MEE]^2'S-#Mjv o0Xw8U'y1M&o\XYEhK~$f~_(X0u40+ i)x4oSL|Rv?s!N1nxcilI/-oYn^l,dk"Q|c3R4i$EUQbT~C*5GzM&#IUN ' _) DO'/?wq_eB|y~X}riY]{_g % *>xzT|IX2Lc
2 +[7y?Yw  l ?\4uu[0ln"'o
0+SS	hv5\MI6F??=zvG5Gci%FS2@ u~xojmElo0wlcrZ7?Yy A,u
.|5>kXYN3nwOUug3a k"W ^t	_Yneqt?x e ?'>jMnsm4>Ysy/f\hb0wC(l.cw[j|[ ;:j $^f=O@cMGk[{AZ7t  k~g&[c. -W-(.X	q `|w|an4[ wf>MFs_@|+ S]/}X66>N=MvRo$z=63{qp,+{ML?pUJp8dge+m=RkHicEQO
o	SO![(=NsE> P 4/g8fj_OP	' j5Ig30` A k!GezxvuRmUg&`}n'> j>GoFk=A`iY0O TG?e?,o~{7?s$/\T<7hFP$upS/.$z\(`UEkqOM!Gf,xszM)+wOT.? o[63J|s pk/5O|:8q)e]Z`E$q>./5?v:>g\[J72 #'OM}ZCerVR=,jrJZ.s"ax
xNF~0|TxN?e"F>yt*vl(~yM5 o
i]k?Z-GD$}%q).`"6WnUp[xxbeqmi{4iJMw	 %' F+O4 _O^_^xRm:8ao,9$b5b8
VM'KRFllbdEy`^?Bu||>XK /??q G_R JObv _Q|k|\>
r:/gM!l20|c5M^[pg(y=qS('m*<U7hkhr H)>, |_0 Zx	 ~?' xz_iqyf#wP>i:_/ut3g<;c"( x"\U
w7GIU_Ns7u/ 'kk #xwty&!{q+m+?T?5q5	pYxOj\CJ55I~
pjM->;&E[oO/d!M_G5]J),Jp	gW=kA}a9Oq#>[ LOq.Z,Tc84s'-\|Ggq%5VoKL~_|U-.no S_ W>>x~xjIH$Q pc}_)Myob||[XK1ZWoK}oBRc1 8NIW1~XE%~^GXk,KZ_= 3|} x[$5q3m:&%!as&z&K~ i? h4A0LbxpaGjGWVQ|J*S\IoEW'QE QE QE QE QE QE QE QE QE QE QExjHA?M>6hG&m1G{|3Uk'Q_S\-Hh6Z%=Rp{j afUYuoXKx(^z3g~xZQak/$yg]x6pdBL3e7$(4H   Hcx" kh:3G'g|i<% 2-f2$l7 =yF%RQoapqR$w[><+LuFK;yG0y$c(}z~m5}UHfsm/)-s?%sM%#c!gxp=j7:o;wk[]cgq%dIr:\utRQN%8:TFJE=[{<&x u9GwinHH3(ZL"NknqIYqG&/E'~/2U)	I!qqjwS=4}$VciN~!NJV]Q^EPEP~gky.W-[>G!t >+o>jZ9<_.%#cd~Qy&rBz/(^Rk=Jh[k	#*?Y$#vc5+eM|bZM[oD~z+2WH&??pU%p?fR>j?cO|d5Xn,|=o v\v  <W1
C-wdq	7Oi~U,i"kGnEhXqUO4QVwhlCC["7TLf.V94W?/YG%p@?[/(c(?_
(,( ( +s<I9-_kE<VW B0jJ#Q&5sZ5R=)8] ] .h\u\ _  g] ] .h\uG~}G _?
_u< 8  .  \gA  f}moZ!7\y[nqdEt
qIvZukT.zn(0( ?	]s_a=xWWm%/,\mn#c:+laBa;o{o>|x;g'_A^;]^Qe5x&S>ZvW(pr=|   C. UK_ /hWf#ajb02Ps_>j\j|(a9Pu'Y<b~~:>+xOkZr?v2NA99=OG5/n\-7y:Lvh	_~EGeiPY[9,uUmCTcmE
pA^o51xV`F\;r=YIY)%W?bi-j79q|[/c[YXRK{"2'kk/ YO5f[f|wEv/\!~4^Pt[kskb&DdS1IXc8{TeZJ2:0:q^5tsvK/;k|E.`{BIYZcqU]jmt
(9B(((((((((((((((((((((((((((((((((((((((((DK67s'+T 8rV5Y ^FR k=?Ww#"3$jH(.[
-*|!lj0NVM|jkNzOc~_POkOB>*8S2]JIxesGQkQ{QMPu	f_k(7G*\RsF> ^xQI<+eoesXI&(R(S<JZnGv(((($f_.)ru2)TjFMT O+9?m=>Zeqk5N~i$MD M[LFRI?1jA($8'_+`1JyC7R"ZuQE}QEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPE:m,P(mM"Z+|g-%eGurY7_R6eN.Sy>o [  r?.Ooz
+ Nuj' 	 AS  ?a?( 9 1\G':5Oh W:>o [  r?.OV^Bo4s cT ?X+z
+ Nuj' 	 AS  ?a?( 9 1\G':5Oh W:>o [  r?.OV^Bo4s cT ?X+z
+ Nuj' 	 AS  ?a?( 9 1\G':5Oh W:>o [  r?.OV^Bo4s cT ?X+z
+ Nuj' 	 AS  ?a?( 9 1\G':5Oh W:>o [  r?.OV^Bo4s cT ?X+z
+ Nuj' 	 AS  ?a?( 9 1\G':5Oh W:>o [  r(37.q=i jCX' P G$z ^ X#(' P G$z ^ Z]2_z y h P G`Ey?$z ^ ?#? 7?%Q^O 	 ?H 4}iv1W Go=C?Z]2_z y h P G`Ey?$z ^ ?#? 7?%Q^O 	 ?H 4}iv1W Go=C?Z]2_z y h P G`Ey?$z ^ ?#? 7?%Q^O 	 ?H 4}iv1W Go=C?Z]2_z y h P G`Ey?$z ^ ?#? 7?%Q^O 	 ?H 4}iv1W Go=C?Z]2_z y h P G`Ey?$z ^ ?#? 7?%Q^O 	 ?H 4}iv1WxRK\j47#c{ Ty i}mvX=C?y iiv1W Go=C?Z]2_z y h P G`Ey?$z ^ ?#? 7?%Q^O 	 ?H 4}iv1W Go=C?Z]2_z y h P G`Ey?$z ^ ?#? 7?%Q^O 	 ?H 4}iv1W Go=C?Z]2_z y h P G`Ey?$z ^ ?#? 7?%Q^O 	 ?H 4}iv1W Go=C?Z]2_z y h P G`Ey?$z ^ ?#? 7?%Q^O 	 ?H 4}iv1W Go=C?Z]2_z y h P G`Ey?$z ^ VoOZ]>Q\>" hLRF$+C]]tBjJFT,(2
(
(
?'[[Yq3K(WW'+[__J$ErjjX~Q_8}QE QE QE QE QE QE QE QE QE QE QE QE QE QE QE QE QE QE QE QEQEzeQEQE QE QE QE QE QE QE QE QE QE QE QE QE QE QE QE QE QE QE W O^>m? TOdQEQ!EPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEP zwV=s$cG [5|+?OM _ taeXK( ( +h?d?O2JG |EQ@Q@Q@Q@Q@Q@Q@Q@Q@Q@Q@Q@Q@Q@Q@Q@Q@Q@Q@QN;[EW[QLAEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEPEP{  @zUJAEUQE QE QE QE QE QE QE QE QE QE QE QE QE QE QE QE QE QE QE |+ zook_+]o?tQEzQE QE ?O2Jj'Gk_O%pf_ Lh((((( ?hOvES[ w5(y$/|Wy5 ,kuh4?|<II	\)^}Q~^_3Ob*G<G5?bG!x'@4 +{V1~=w7lY~><	6:{qbycV$Q@!J ? !fivS;4ib8^/hF-?i/ZW5:>f 3Eb!H%^Wx[ i'&^kR'<MfPm`ub35)r^7J5cer]OS)/|I.~?n]BWmnmgY,UX|!~~3m4W;kXt
m 1$Usj]7r0\?:M^VZSf4wYOkyRUH+d;_7o_xo?|cjBlCl ]3l5*p'k^'EZ!zkx xE|  l_el*nn23#o xGAxOnDTE0BG 5 X Du{L;,dpz}% &>|zGhxT[ka|. ('ctk[9r"+7)J >>[O|Ca A5(dD*xzk	O>,(XGowH~X2H$A3TiU~iWWpsKN7mZ+O'+oK\>j4L$u%\k-OM+;d'hIz:kmjTamdW_'{XV]4V "eQ5qcM1miCO_+[ xQEqQ@Q@Q@Q@QN;[EW[QLAEPEPEPEPEP
_CM_G4w<<ybOJ*	^x	O#&iUDPK1< M| K  u<N""J2I&#kIonG[-~Z/HB.xI|E;fl=15w8i .<}&${~vU{|> 2O}SCVCkZIm0S[`pck a_#"k+:$~zcO3L>"u*Rm-,sB3J)N4&nM;|+GBwr&i`3w2+a}z0]-aEe ])X|<+&|1xOX.i%v+coxZ>,]=MCXK#@OlkSmgo]K u},.)DIW8?+{y4"|bx'K
W<{}xn4xTv~7#l 0BN.7:aOeJqSRVIzc+?c5WW?rq
60Tc<t&:x}5[p-FH@`~'
GNW|K?xMRT{]'Cl-u]&_.UVWCYH`x~+ //1m.ok$hF7f$	wWVWa~+*qKwk_.Wc wxc>*u^wq,IHI[#F65>K4nz0yL]8jc#
&qwW[++R +y\xx&*#WF`	cm+){jWOWndvw+
(
(
(
(
(+ u?{ 6 V*V
(( ( ( ( < /:/#>'XQ$u-C)=@<Wu;moLW0m,XZIs"'g$3E|Nt)+7.aSVKpu.zO Ax} %zvuou<i2,	'9k~x\|WcejI.4GR wnX>!i>t)a_RWSaoB)jv~\\U6
Wj<^; GJ4i-uC:B"m)m  'ushj,g)>~FDc=sC?JWi;wb*p:R_v}+swE<7}wXvcrc#>}xP"hvA!_/yzQWe\?gwGhC'/dgoW `/x':Vm508,Q_V :'W(}QwRpB
0k\EG*~>ITI]eeuhL
?i/3\P;e3V @Tk#_sT RuY[(x2cU}]qyWVM$tXp7C4vI&/c,.!D0yV&C@
Z,]=VMCXY+@I0_ jWWlnZO^doD8>^?~s;xW,|EgX[$112GK<qK2T"m#uuoeX:kY$>k?~"^Pf1pJ$EJa]k?wiiZOM[(k(:r;xi?[u#7~Z)]j,	STaYxV)ON!8:n|#^e<I]Kga  )7?Z;f}Z$Dda,AgCy'|?{qwH	$ $sp	 \3$N&y8*p>5RN.z+f>0k^m[&. V_*VUuUQ]8*wMYO[oi(>h<( ( ( ( _+\w
 ^ AZ|ga+<( ( v  WW?;Z +2GgEWhQE QE QE QE QE }~ _WP~^	O$N kic$8x89.U{M3xn:ni^WaoY~ w?g\F>L@c@0~wZWO2[^Y\ ,I{Ue ][N%$eaX7
}o|1f_~
kQkjcXYNn	($29+K1\y`s\=|$F j7M|wwo bZV)<0-_8+l|!STcIZ)v8U yk<?qO>$fvX~iPWHde&+ O/dW_Q$vrB>QE<}\ U
iWmr}|*F^I(w]t2o~7;XuCR+X &&5l4"9$\~?[okveruwU"I9!	W	hxGVKQ3]XB$s	|	#+#83SowP=J	<;=Rg+N8l]Zxy)(}raeIb*~tNUt^8$+PW8 oD/% q4vw}Dpz^M a<ScSN]oOJ1*)89i/[ZxfpFQNk<.;s\v>s5Z}U|]gO. G\t__|W}/c7m-#3aA' 	&I.>%D~gWogE5]KMmoaYe<?
l~~]~!{+|BO8Z]W"232ViWvtZpB#{RrL\ oj,?o- US2I;F|=tPk>?QVX^k<K(_'ZvM>"O%4sc0c}G{os
;[u4.LInT<S3>!VikW]oG.I~ O/>-N3zuhk9.G/k$|] . fvM(H/iZF3OSI_McF;E$|Na+<Dl(8(((((-@+-( ( ( ( ( ('/ ~M$\]ZN\*YVEx?<- 5~~~#(4_O'Zk\3^|*W&wkfz~
^~x>9 UxS}[VThc]B(_	 "' <=G6	{8V+In!,r$'x^)?w~OoIAm(=.CDk0XT].=yZE6yOL_i^H(l#"3?Z}sTsUQb}k_)&xj_uKo5$L`Tg W5t9E{y+:c8JQWR}4<8ff(q{o9|*C<']z84_C[n u@8aPw[W5P `Yk6{AR"8b:HSj~:_?9RM6+$%#
lu79b(n|iN8LNWa*%W<Moh_EoCj;u7C7h=jz/zIu-+y,1V2 k2}5;30nOvA(HVHe`YrMw d QE<e}gLo?L.mRa6Z5p*t76ZWO}-ub)%Rjc);8"3Eu@TO.G3mk5<Kg"sON}M|G~?i5Xf";{hvp/	p2q^ <Ex^ t-n]H0mjT+FW}'0ZRyV yO]sJ0:U>-~Qk?T>.?"Iw'_|;_h8t'K-|U}&Mw$%H=s5Fq8i=eGFx,[iU# B2<Q}nc"${=x+v,1'a
)#s,lx&QEpQ@Q@Q@Q@Q@W O+vSQTHQE QE QE QE W O\fQm*:}IK~